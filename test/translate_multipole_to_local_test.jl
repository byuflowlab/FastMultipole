@testset "multipole-to-local z translation" begin

expansion_order = 10
r = 5.4084748312255275

original_weights_test = ComplexF64[0.6999999999999996 + 0.0im, 0.11435215122567652 + 0.08189581451521355im, -0.03836201636774318 + 1.3877787807814457e-17im, -0.11435215122567657 + 0.08189581451521355im, 0.004549635753449806 + 0.013378517951705228im, -0.006266827281437194 - 0.004488126538403245im, -0.02721073825021538 - 8.673617379884035e-19im, 0.006266827281437211 - 0.004488126538403264im, 0.004549635753449813 - 0.013378517951705225im, -0.0002739923756957475 + 0.0009059325875072068im, -0.00024933314463015954 - 0.0007331813209135163im, -0.0021367159928419844 - 0.001530256271927357im, 0.0015296317643510027 - 1.5178830414797062e-18im, 0.0021367159928419796 - 0.0015302562719273585im, -0.00024933314463016095 + 0.0007331813209135156im, 0.00027399237569574776 + 0.0009059325875072065im, -3.768703740357878e-5 + 2.8984468381546753e-5im, 1.501557143011016e-5 - 4.964771535717637e-5im, -5.439715497410481e-5 - 0.00015995858872678634im, 0.00012337202844684268 + 8.835559847150261e-5im, 0.000243085553397119 + 3.8963515573697816e-20im, -0.00012337202844684344 + 8.835559847150226e-5im, -5.4397154974105354e-5 + 0.00015995858872678656im, -1.5015571430109988e-5 - 4.964771535717632e-5im, -3.768703740357865e-5 - 2.898446838154676e-5im, -1.909514413376855e-6 + 6.515019620888022e-8im, 2.065358208182621e-6 - 1.5884323578046087e-6im, 2.354104793625848e-6 - 7.783648145453378e-6im, 3.230732826492526e-6 + 9.500192863488027e-6im, 1.2109979083592825e-5 + 8.672828540459939e-6im, -1.4860820883923302e-5 - 1.1858461261560205e-20im, -1.2109979083592848e-5 + 8.672828540459898e-6im, 3.2307328264925676e-6 - 9.500192863488032e-6im, -2.3541047936258565e-6 - 7.783648145453364e-6im, 2.0653582081826184e-6 + 1.5884323578046096e-6im, 1.909514413376857e-6 + 6.515019620888026e-8im, -5.3260145083435966e-8 - 3.545980312447065e-8im, 1.046468902577199e-7 - 3.570418419037643e-9im, 2.4772271412564214e-7 - 1.905193846381726e-7im, -1.440440911664669e-7 + 4.7626958923289976e-7im, 2.1877324616077317e-7 + 6.433178302011217e-7im, -7.884279367204045e-7 - 5.646500513736619e-7im, -8.619166618975979e-7 + 8.602678370551488e-22im, 7.884279367204036e-7 - 5.646500513736628e-7im, 2.1877324616077645e-7 - 6.433178302011223e-7im, 1.4404409116646503e-7 + 4.762695892328995e-7im, 2.47722714125642e-7 + 1.9051938463817313e-7im, -1.046468902577199e-7 - 3.570418419037872e-9im, -5.326014508343587e-8 + 3.545980312447063e-8im, -6.502862664193638e-10 - 1.7176913739038119e-9im, 2.918809367770216e-9 + 1.9432993540827024e-9im, 9.981698236943087e-9 - 3.4056281224112134e-10im, -1.5643586764223977e-8 + 1.2031220206727636e-8im, -7.115695850248475e-9 + 2.3527445744286195e-8im, -1.527372895305385e-8 - 4.4913454188714863e-8im, -2.9799707770934797e-8 - 2.1341717790684364e-8im, 6.242177023239851e-8 - 9.26442286059391e-23im, 2.9799707770934708e-8 - 2.134171779068417e-8im, -1.5273728953053515e-8 + 4.4913454188715075e-8im, 7.115695850248551e-9 + 2.3527445744286242e-8im, -1.5643586764224023e-8 - 1.2031220206727666e-8im, -9.981698236943123e-9 - 3.4056281224113644e-10im, 2.9188093677702243e-9 - 1.9432993540827248e-9im, 6.502862664193634e-10 - 1.7176913739038175e-9im, 1.184108940607856e-11 - 4.458525485788513e-11im, 3.563756056585387e-11 + 9.413443514346902e-11im, 2.272109446554497e-10 + 1.512736278240615e-10im, -6.517897611841971e-10 + 2.223823529721132e-11im, -5.810558797344375e-10 + 4.468803316568363e-10im, 5.371756807258453e-10 - 1.7761258982122274e-9im, -3.905422308097819e-10 - 1.148416385163552e-9im, 2.447508618419346e-9 + 1.7528372635761151e-9im, 1.413623416230522e-9 + 5.324975193310116e-24im, -2.4475086184193517e-9 + 1.752837263576114e-9im, -3.9054223080978644e-10 + 1.1484163851635528e-9im, -5.371756807258464e-10 - 1.7761258982122272e-9im, -5.810558797344404e-10 - 4.4688033165683696e-10im, 6.517897611841983e-10 + 2.2238235297212574e-11im, 2.2721094465544932e-10 - 1.5127362782406144e-10im, -3.563756056585371e-11 + 9.413443514346865e-11im, 1.1841089406078629e-11 + 4.458525485788513e-11im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im]

translated_weights_test = ComplexF64[0.12778297701763344 + 4.529689653984123e-19im, 0.001391230916148547 + 0.0009963606966333042im, 0.023263561490208483 + 1.6161375594375092e-19im, -0.0013912309161485475 + 0.000996360696633304im, 2.2134138954161076e-5 + 6.508696330673166e-5im, 0.000759842664558462 + 0.0005441780784221299im, 0.008447591019402909 + 8.567077765008989e-20im, -0.0007598426645584622 + 0.0005441780784221297im, 2.2134138954161103e-5 - 6.508696330673164e-5im, -1.3325883651116576e-6 + 4.406090580520993e-6im, 2.0148177569960395e-5 + 5.9247106784201074e-5im, 0.0005525848886053127 + 0.0003957458522299252im, 0.0045887531061914915 + 5.989877932150117e-20im, -0.0005525848886053129 + 0.0003957458522299251im, 2.014817756996042e-5 - 5.924710678420107e-5im, 1.33258836511166e-6 + 4.406090580520993e-6im, -3.4206466358713117e-7 + 2.6307619566944625e-7im, -1.6982339373065263e-6 + 5.615066700706485e-6im, 2.1988634672519828e-5 + 6.465909792376966e-5im, 0.0005016422299307472 + 0.00035926214395678107im, 0.003314320404444147 + 5.1690819614251094e-20im, -0.0005016422299307476 + 0.00035926214395678096im, 2.1988634672519848e-5 - 6.465909792376964e-5im, 1.6982339373065294e-6 + 5.6150667007064845e-6im, -3.420646635871298e-7 - 2.630761956694463e-7im, -5.1964810233878385e-8 + 1.772973044339273e-9im, -5.604877581930479e-7 + 4.3106173434709265e-7im, -2.4717086836896375e-6 + 8.172495448798503e-6im, 2.797142181664951e-5 + 8.225189645676838e-5im, 0.0005457288925472197 + 0.00039083577948120606im, 0.0029838956834344252 + 5.271818262398884e-20im, -0.00054572889254722 + 0.00039083577948120584im, 2.797142181664954e-5 - 8.225189645676835e-5im, 2.471708683689643e-6 + 8.1724954487985e-6im, -5.604877581930458e-7 - 4.310617343470928e-7im, 5.1964810233878444e-8 + 1.7729730443392582e-9im, -6.337822009645501e-9 - 4.219626520879692e-9im, -1.0405655587458005e-7 + 3.550276962853927e-9im, -1.0198862188421203e-6 + 7.843773854189347e-7im, -4.044411742830995e-6 + 1.3372504931290617e-5im, 4.0628271516089375e-5 + 0.00011947023658160036im, 0.0006916861128969572 + 0.0004953662611275738im, 0.00321445813164447 + 6.154193656051575e-20im, -0.0006916861128969576 + 0.0004953662611275737im, 4.0628271516089395e-5 - 0.00011947023658160033im, 4.044411742831004e-6 + 1.3372504931290615e-5im, -1.0198862188421163e-6 - 7.843773854189347e-7im, 1.0405655587458017e-7 + 3.550276962853892e-9im, -6.337822009645483e-9 + 4.219626520879682e-9im, -4.850548473552276e-10 - 1.281242692945013e-9im, -1.4976522040492022e-8 - 9.971143004082905e-9im, -2.272028196381298e-7 + 7.751870410058064e-9im, -2.0403346720951817e-6 + 1.56918717589355e-6im, -7.348117334596896e-6 + 2.4295927699937256e-5im, 6.632824622718781e-5 + 0.00019504278604780552im, 0.0010005311974244245 + 0.0007165524783110215im, 0.0040281041028420094 + 8.008865410102361e-20im, -0.0010005311974244251 + 0.0007165524783110211im, 6.632824622718787e-5 - 0.0001950427860478055im, 7.348117334596914e-6 + 2.4295927699937253e-5im, -2.0403346720951732e-6 - 1.56918717589355e-6im, 2.272028196381301e-7 + 7.75187041005798e-9im, -1.4976522040491982e-8 + 9.971143004082879e-9im, 4.850548473552277e-10 - 1.2812426929450188e-9im, 8.545538450917311e-11 - 3.217651659115236e-10im, -1.3291888654895092e-9 - 3.510971039126862e-9im, -3.8087512283686144e-8 - 2.535809252799804e-8im, -5.371730943499214e-7 + 1.8327660817778287e-8im, -4.450538574776133e-6 + 3.4228345735980684e-6im, -1.4675533327698911e-5 + 4.85234081672911e-5im, 0.00012020649674840666 + 0.0003534755004157713im, 0.0016259096452244542 + 0.001164431043024402im, 0.0057513388353230355 + 1.1330384369444543e-19im, -0.001625909645224455 + 0.0011644310430244012im, 0.00012020649674840675 - 0.00035347550041577117im, 1.4675533327698947e-5 + 4.852340816729109e-5im, -4.4505385747761155e-6 - 3.4228345735980684e-6im, 5.371730943499222e-7 + 1.8327660817778065e-8im, -3.808751228368603e-8 + 2.5358092527997975e-8im, 1.3291888654895092e-9 - 3.510971039126878e-9im, 8.545538450917362e-11 + 3.217651659115236e-10im, 0.0 + 0.0im, 2.6860465879745264e-10 - 1.0113771425754109e-9im, -3.884612856493065e-9 - 1.0260967114213813e-8im, -1.0370996293750355e-7 - 6.904853267014005e-8im, -1.3670742035582628e-6 + 4.6642828129491136e-8im, -1.0511400344112262e-5 + 8.08414170785338e-6im, -3.195242472252184e-5 + 0.00010564798649049682im, 0.00023941390977500466 + 0.000704013126190185im, 0.0029315988095909877 + 0.0020995291279607853im, 0.009209306836398234 + 1.6927828179927868e-19im, -0.00293159880959099 + 0.002099529127960783im, 0.00023941390977500474 - 0.0007040131261901848im, 3.195242472252193e-5 + 0.00010564798649049681im, -1.0511400344112218e-5 - 8.08414170785338e-6im, 1.3670742035582645e-6 + 4.664282812949053e-8im, -1.0370996293750327e-7 + 6.904853267013984e-8im, 3.884612856493065e-9 - 1.0260967114213861e-8im, 2.686046587974542e-10 + 1.0113771425754109e-9im, 0.0 + 0.0im, 0.0 + 0.0im, 0.0 + 0.0im, 8.93945892183914e-10 - 3.365974537082629e-9im, -1.2060703617661258e-8 - 3.185761046644538e-8im, -3.0100660251167315e-7 - 2.004056663290852e-7im, -3.7258394471335386e-6 + 1.271208896476863e-7im, -2.6722077396009983e-5 + 2.055150154361424e-5im, -7.531447523516347e-5 + 0.00024902093444492175im, 0.0005197037718196129 + 0.001528224811312758im, 0.005806071851752234 + 0.004158146377978563im, 0.016331449987109083 + 2.5569986101798374e-19im, -0.005806071851752238 + 0.004158146377978559im, 0.000519703771819613 - 0.0015282248113127575im, 7.531447523516369e-5 + 0.0002490209344449217im, -2.6722077396009868e-5 - 2.055150154361424e-5im, 3.725839447133543e-6 + 1.2712088964768447e-7im, -3.0100660251167236e-7 + 2.004056663290846e-7im, 1.206070361766126e-8 - 3.1857610466445534e-8im, 8.939458921839191e-10 + 3.365974537082629e-9im, 0.0 + 0.0im, 0.0 + 0.0im]

original_weights = initialize_expansion(expansion_order)
i_compressed, i = 1, 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            original_weights[1,1,i_compressed] = real(original_weights_test[i])
            original_weights[2,1,i_compressed] = imag(original_weights_test[i])
            i_compressed += 1
        end
        i += 1
    end
end
z_translated_weights = initialize_expansion(expansion_order)

FastMultipole.translate_multipole_to_local_z!(z_translated_weights, original_weights, r, expansion_order, Val(false))

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(z_translated_weights[1,1,i_compressed], real(translated_weights_test[i]); atol=1e-12)
            @test isapprox(z_translated_weights[2,1,i_compressed], imag(translated_weights_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

@testset "multipole-to-local: point-and-shoot" begin

#--- m2l ---#

multipole_expansion_test = ComplexF64[0.6999999999999997 + 0.0im, -0.04549999999999994 + 0.105im, -0.16800000000000004 + 1.3877787807814457e-17im, 0.04549999999999993 + 0.10500000000000002im, -0.006396250000000003 - 0.0068249999999999995im, 0.01092 - 0.025200000000000018im, 0.0014525000000000215 - 3.0357660829594124e-18im, -0.010919999999999996 - 0.025200000000000007im, -0.0063962500000000104 + 0.0068249999999999995im, 0.0004798354166666664 - 0.0001719375000000007im, 0.0015351000000000026 + 0.0016380000000000001im, -0.000702406250000003 + 0.0016209375000000048im, 0.002877000000000001 + 2.032879073410321e-18im, 0.0007024062500000036 + 0.0016209375000000043im, 0.001535100000000001 - 0.0016380000000000006im, -0.0004798354166666666 - 0.00017193750000000076im, -1.349669270833318e-6 + 2.0787812499999992e-5im, -0.00011516050000000012 + 4.126500000000017e-5im, -0.0001272320729166672 - 0.00013576062500000074im, -4.1086500000000305e-5 + 9.481499999999968e-5im, -0.0003170185156250007 + 2.574980159653073e-19im, 4.1086499999999845e-5 + 9.481499999999992e-5im, -0.00012723207291666732 + 0.00013576062500000053im, 0.00011516049999999991 + 4.126500000000027e-5im, -1.3496692708333037e-6 - 2.0787812499999968e-5im, -6.060886744791647e-7 - 3.1073164062500083e-7im, 3.2392062499999894e-7 - 4.989075000000009e-6im, 1.0613359622395866e-5 - 3.803042578125005e-6im, 1.0617775000000085e-6 + 1.1329500000000223e-6im, 8.512194505208337e-6 - 1.9643525781250052e-5im, 8.459739750000029e-6 - 9.621764885216818e-21im, -8.51219450520835e-6 - 1.964352578125004e-5im, 1.0617775000000064e-6 - 1.132950000000002e-6im, -1.0613359622395861e-5 - 3.8030425781250114e-6im, 3.2392062499999973e-7 + 4.989075000000003e-6im, 6.060886744791676e-7 - 3.107316406249977e-7im, 1.4334251655815862e-8 - 1.1785957421874977e-8im, 1.4546128187499996e-7 + 7.457559375000023e-8im, -3.165649274739567e-8 + 4.875781421875009e-7im, -3.361247093750007e-7 + 1.2044221875000181e-7im, 5.664557310872387e-7 + 6.044260878906261e-7im, -4.4895612124999894e-7 + 1.0360525875000018e-6im, 8.282175800086792e-7 - 1.2440796412797536e-21im, 4.489561212499997e-7 + 1.0360525875000018e-6im, 5.664557310872379e-7 - 6.044260878906239e-7im, 3.361247093750014e-7 + 1.204422187500027e-7im, -3.165649274739555e-8 - 4.87578142187501e-7im, -1.4546128187499985e-7 + 7.457559374999987e-8im, 1.4334251655815926e-8 + 1.1785957421874967e-8im, 1.1945246509331658e-10 + 4.166035686848929e-10im, -3.4402203973958246e-9 + 2.8286297812500157e-9im, -1.4755733854090762e-8 - 7.565020734049502e-9im, 1.3782822593751201e-9 - 2.1228514125000105e-8im, -1.742971411585279e-8 + 6.245519540039172e-9im, -4.315565066093784e-8 - 4.60484370937502e-8im, 1.014796235920893e-11 - 2.3418374674634617e-11im, -8.113604160208373e-8 + 6.839749690047848e-23im, -1.0147962359084724e-11 - 2.3418374674701874e-11im, -4.315565066093773e-8 + 4.6048437093750295e-8im, 1.7429714115852835e-8 + 6.245519540039171e-9im, 1.3782822593750972e-9 + 2.1228514125000177e-8im, 1.4755733854090784e-8 - 7.565020734049517e-9im, -3.440220397395837e-9 - 2.828629781250015e-9im, -1.194524650933184e-10 + 4.1660356868489757e-10im, -8.781868191725026e-12 - 1.1451702750650282e-12im, -2.8668591622395835e-11 - 9.998485648437498e-11im, 3.581003226158312e-10 - 2.944384720214827e-10im, 7.485195129817689e-10 + 3.8375357617187514e-10im, 5.118269233269606e-12 - 7.883236541341235e-11im, 2.146172463804682e-9 - 7.690293696093717e-10im, 1.0363062435920718e-9 + 1.105771367991532e-9im, 1.1716944330338507e-9 - 2.7039102300781144e-9im, 2.4351243415011286e-9 + 3.764318021969833e-25im, -1.171694433033852e-9 - 2.7039102300781165e-9im, 1.0363062435920718e-9 - 1.1057713679915313e-9im, -2.1461724638046818e-9 - 7.690293696093704e-10im, 5.1182692332707e-12 + 7.883236541340832e-11im, -7.485195129817695e-10 + 3.8375357617187654e-10im, 3.5810032261583075e-10 + 2.9443847202148314e-10im, 2.8668591622395974e-11 - 9.9984856484375e-11im, -8.781868191725026e-12 + 1.145170275065034e-12im, 8.251077485798615e-14 - 1.3809379565327995e-13im, 2.107648366013989e-12 + 2.7484086601560455e-13im, 3.0411851034851396e-12 + 1.0606466481486932e-11im, -1.9891845797799494e-11 + 1.635554148515634e-11im, -1.1190024892280568e-11 - 5.7369407148234005e-12im, -3.809384155983201e-12 + 5.867271729921865e-11im, -8.179438444812925e-11 + 2.930905366208124e-11im, 3.728539038790368e-11 + 3.9784684682031734e-11im, -5.977728283232749e-11 + 1.3794757576690937e-10im, 4.211816703972952e-11 - 2.9702821892105713e-25im, 5.977728283232793e-11 + 1.3794757576690918e-10im, 3.7285390387903514e-11 - 3.9784684682031553e-11im, 8.17943844481299e-11 + 2.930905366208131e-11im, -3.8093841559830475e-12 - 5.86727172992186e-11im, 1.1190024892280814e-11 - 5.736940714823451e-12im, -1.9891845797799484e-11 - 1.6355541485156374e-11im, -3.041185103485168e-12 + 1.0606466481486971e-11im, 2.107648366014002e-12 - 2.7484086601562046e-13im, -8.251077485798951e-14 - 1.380937956532785e-13im, 1.5350868982223542e-15 + 2.1352712946161606e-15im, -1.9802585965916942e-14 + 3.314251095678728e-14im, -2.2684053420791762e-13 - 2.958038441063875e-14im, -1.7944746568643672e-13 - 6.258427110568864e-13im, 4.968642776197102e-13 - 4.0853344569966455e-13im, -9.613992850227022e-13 - 4.928935149423792e-13im, 1.9677186264774175e-13 - 3.0307103187372887e-12im, 2.1908816250110458e-13 - 7.850498239940796e-14im, -3.5468099712472366e-12 - 3.7845578352569925e-12im, 8.064714695085473e-13 - 1.861088006558112e-12im, -5.926367958781035e-12 - 1.2275735717080334e-26im, -8.064714695085366e-13 - 1.8610880065581227e-12im, -3.5468099712472462e-12 + 3.784557835256975e-12im, -2.1908816250109169e-13 - 7.850498239940379e-14im, 1.9677186264775914e-13 + 3.030710318737274e-12im, 9.613992850226972e-13 - 4.92893514942387e-13im, 4.968642776197119e-13 + 4.0853344569966147e-13im, 1.7944746568643296e-13 - 6.258427110568828e-13im, -2.268405342079182e-13 + 2.958038441063794e-14im, 1.9802585965916718e-14 + 3.314251095678763e-14im, 1.535086898222355e-15 - 2.1352712946161496e-15im]

local_expansion_test = ComplexF64[0.12778297701518376 + 4.529876741832122e-19im, 0.019885650678973195 + 0.01107124020670927im, 0.00510980317232747 + 3.2526065174565133e-19im, -0.019885650678973195 + 0.011071240206709273im, 0.0064061759144352455 + 0.010337471569752702im, 0.0023855703622443353 + 0.0013281548055632461im, -0.0036451747846196194 + 1.3552527156068805e-20im, -0.0023855703622443353 + 0.0013281548055632461im, 0.006406175914435242 - 0.010337471569752699im, 0.0005064190022021772 + 0.010818798690701376im, 0.0012808551957074808 + 0.002066881139248646im, -0.0015110027312699105 - 0.0008412434906155766im, -0.0014099237691522458 - 3.078435367677348e-20im, 0.0015110027312699103 - 0.000841243490615576im, 0.0012808551957074834 - 0.002066881139248649im, -0.0005064190022021772 + 0.01081879869070138im, -0.006009793726612699 + 0.012092524384091887im, 0.0001417552658790099 + 0.0030283652182560737im, -0.0007088462398745658 - 0.0011438458681310513im, -0.0010589187153643683 - 0.0005895478929899509im, 0.0006985665385679235 - 1.6246158102786485e-19im, 0.0010589187153643683 - 0.0005895478929899511im, -0.0007088462398745665 + 0.001143845868131052im, -0.00014175526587901024 + 0.003028365218256073im, -0.006009793726612695 - 0.012092524384091866im, -0.017846595532800602 + 0.012250353278672752im, -0.002162884088792063 + 0.004352017677578853im, -6.711262856316067e-5 - 0.0014337495358817235im, -0.0007672990921280057 - 0.001238169644439577im, 0.00037417962143503 + 0.00020832270127265864im, 0.0010031456973652096 + 1.1641388389310976e-19im, -0.00037417962143503075 + 0.00020832270127265875im, -0.0007672990921280062 + 0.0012381696444395776im, 6.711262856316106e-5 - 0.0014337495358817233im, -0.002162884088792063 - 0.004352017677578859im, 0.017846595532800612 + 0.012250353278672748im, -0.042225463605343794 + 0.003961758529385453im, -0.007850173158406528 + 0.005388556820064021im, 0.0008510166456805201 - 0.001712361533117437im, -0.00010510118334571114 - 0.0022453118014719325im, 0.00015853373605836303 + 0.0002558215695988765im, 0.0010114739345698297 + 0.0005631332399612264im, -0.00014071293037591607 - 9.550575653748973e-21im, -0.0010114739345698288 + 0.0005631332399612264im, 0.00015853373605836257 - 0.00025582156959887614im, 0.00010510118334571061 - 0.0022453118014719325im, 0.0008510166456805199 + 0.0017123615331174377im, 0.00785017315840652 + 0.005388556820064014im, -0.04222546360534374 - 0.003961758529385418im, -0.0898871776608148 - 0.03954501185622584im, -0.021950729024970004 + 0.002059503335441688im, 0.0024609315428810066 - 0.001689245509397466im, 0.0018838924974092155 - 0.0037906485449506547im, 5.747049395530121e-6 + 0.00012277601925042277im, 0.0009006227210246704 + 0.0014533103533101127im, 8.939703291639945e-5 + 4.977136851668339e-5im, -0.0012765668446022285 - 3.0322332914984265e-21im, -8.939703291640068e-5 + 4.9771368516682795e-5im, 0.00090062272102467 - 0.0014533103533101114im, -5.747049395528063e-6 + 0.0001227760192504233im, 0.0018838924974092148 + 0.0037906485449506486im, -0.002460931542881007 - 0.0016892455093974695im, -0.021950729024970004 - 0.002059503335441686im, 0.08988717766081487 - 0.039545011856225824im, -0.15843104206588102 - 0.20912889072046756im, -0.05391631110482998 - 0.02371997082262677im, 0.005125742654887659 - 0.00048091743305941914im, 0.007754396968857491 - 0.005322813591027322im, 0.00019415961489653826 - 0.0003906755422485134im, 0.00014354055241060798 + 0.003066504938691552im, 0.0003024832875984886 + 0.00048810905505965093im, -0.0015642560093754251 - 0.0008708919964507312im, -0.0005359499879630815 - 3.595940057662025e-19im, 0.0015642560093754268 - 0.0008708919964507314im, 0.0003024832875984912 - 0.0004881090550596528im, -0.0001435405524106079 + 0.003066504938691553im, 0.00019415961489653837 + 0.0003906755422485172im, -0.007754396968857492 - 0.005322813591027318im, 0.005125742654887643 + 0.00048091743305941036im, 0.053916311104829986 - 0.02371997082262679im, -0.15843104206588127 + 0.20912889072046767im, -0.11111181626367748 - 0.7866131166651296im, -0.10770115350524719 - 0.14216547272568164im, 0.008278040628995856 + 0.0036418443551435855im, 0.023965741986170058 - 0.0022485595589336192im, 0.0020731640436027305 - 0.0014230718319763903im, -0.0028813446483857623 + 0.005797658260935966im, 8.704546346131179e-5 + 0.001859582317510436im, -0.0015950835889545984 - 0.002573942930823183im, -0.0012510567024948025 - 0.0006965198006367075im, 0.0023581970021940317 + 3.0687254736751804e-19im, 0.0012510567024948019 - 0.0006965198006367068im, -0.001595083588954596 + 0.0025739429308231803im, -8.70454634613075e-5 + 0.0018595823175104364im, -0.002881344648385754 - 0.005797658260935955im, -0.002073164043602728 - 0.0014230718319764041im, 0.02396574198617004 + 0.0022485595589336145im, -0.008278040628995845 + 0.0036418443551436874im, -0.10770115350524703 + 0.14216547272568159im, 0.11111181626367828 - 0.7866131166651301im, 0.9663711734836324 - 2.508759177188856im, -0.08441990368301502 - 0.5976486719026123im, 0.007922361746069495 + 0.010457501159777857im, 0.06378311778978472 + 0.028060780289836783im, 0.010522228941126748 - 0.0009872353870384969im, -0.012895443750939348 + 0.008851757750809815im, -0.0026097270576833707 + 0.005251126044978767im, -0.0002782602251141857 - 0.005944565639853102im, -0.001988047464755652 - 0.003208058151555278im, 0.003219591093161612 + 0.001792491815832389im, 0.003238333965118483 + 1.0935200630559608e-18im, -0.003219591093161612 + 0.001792491815832389im, -0.0019880474647556556 + 0.003208058151555279im, 0.00027826022511419216 - 0.005944565639853118im, -0.002609727057683363 - 0.005251126044978756im, 0.012895443750939376 + 0.00885175775080986im, 0.010522228941126768 + 0.0009872353870385342im, -0.06378311778978484 + 0.028060780289836707im, 0.007922361746068505 - 0.010457501159777267im, 0.08441990368301505 - 0.5976486719026121im, 0.9663711734836303 + 2.508759177188862im]

expansion_order = 10
box = SVector{3}(0.0,0.0,0.0)

source_branch = Branch(2:2, 0, 1:0, 0, 1, SVector{3}([0.2, 0.4, -0.15999999999999998]), SVector{3}([0.2, 0.4, -0.15999999999999998]), 0.0, 0.0, box, box)
multipole_expansion = FastMultipole.initialize_expansion(expansion_order)
target_branch = Branch(2:2, 0, 1:0, 0, 1, SVector{3}([2.5, -4.3999999999999995, 0.8]), SVector{3}([2.5, -4.3999999999999995, 0.8]), 0.0, 0.0, box, box)
local_expansion = FastMultipole.initialize_expansion(expansion_order)

i, i_compressed = 1, 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            multipole_expansion[1,1,i_compressed] = real(multipole_expansion_test[i])
            multipole_expansion[2,1,i_compressed] = imag(multipole_expansion_test[i])
            i_compressed += 1
        end
        i += 1
    end
end

# preallocate containers
Hs_π2 = [1.0]
FastMultipole.update_Hs_π2!(Hs_π2, expansion_order)
Ts = zeros(FastMultipole.length_Ts(expansion_order))
eimϕs = zeros(2, expansion_order+1)
weights_tmp_1 = initialize_expansion(expansion_order, eltype(Ts))
weights_tmp_2 = initialize_expansion(expansion_order, eltype(Ts))
weights_tmp_3 = initialize_expansion(expansion_order, eltype(Ts))

# normalization
ζs_mag = zeros(FastMultipole.length_ζs(expansion_order))
FastMultipole.update_ζs_mag!(ζs_mag, 0, expansion_order)
ηs_mag = zeros(FastMultipole.length_ηs(expansion_order))
FastMultipole.update_ηs_mag!(ηs_mag, 0, expansion_order)

# perform transformation
lamb_helmholtz = Val(false)
FastMultipole.multipole_to_local!(local_expansion, target_branch, multipole_expansion, source_branch, weights_tmp_1, weights_tmp_2, weights_tmp_3, Ts, eimϕs, ζs_mag, ηs_mag, Hs_π2, FastMultipole.M̃, FastMultipole.L̃, expansion_order, lamb_helmholtz)

i = 1
i_compressed = 1
for n in 0:expansion_order
    for m in -n:n
        if m >= 0
            @test isapprox(local_expansion[1,1,i_compressed], real(local_expansion_test[i]); atol=1e-12)
            @test isapprox(local_expansion[2,1,i_compressed], imag(local_expansion_test[i]); atol=1e-12)
            i_compressed += 1
        end
        i += 1
    end
end

end

