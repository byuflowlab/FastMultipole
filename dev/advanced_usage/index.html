<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Advanced Usage · FastMultipole.jl</title><meta name="title" content="Advanced Usage · FastMultipole.jl"/><meta property="og:title" content="Advanced Usage · FastMultipole.jl"/><meta property="twitter:title" content="Advanced Usage · FastMultipole.jl"/><meta name="description" content="Documentation for FastMultipole.jl."/><meta property="og:description" content="Documentation for FastMultipole.jl."/><meta property="twitter:description" content="Documentation for FastMultipole.jl."/><meta property="og:url" content="https://flow.byu.edu/FastMultipole/advanced_usage/"/><meta property="twitter:url" content="https://flow.byu.edu/FastMultipole/advanced_usage/"/><link rel="canonical" href="https://flow.byu.edu/FastMultipole/advanced_usage/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">FastMultipole.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../quickstart/">Quick Start</a></li><li><a class="tocitem" href="../guided_examples/">Guided Examples</a></li><li class="is-active"><a class="tocitem" href>Advanced Usage</a><ul class="internal"><li><a class="tocitem" href="#Simultaneous-Computation-of-Multiple-and-Distinct-Source-and-Target-Systems"><span>Simultaneous Computation of Multiple and Distinct Source and Target Systems</span></a></li><li><a class="tocitem" href="#Satisfying-an-Error-Tolerance"><span>Satisfying an Error Tolerance</span></a></li><li><a class="tocitem" href="#Fully-Automatic-Tuning-of-FMM-Parameters"><span>Fully Automatic Tuning of FMM Parameters</span></a></li></ul></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Advanced Usage</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Advanced Usage</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/byuflowlab/FastMultipole" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/byuflowlab/FastMultipole/blob/main/docs/src/advanced_usage.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Advanced-Usage"><a class="docs-heading-anchor" href="#Advanced-Usage">Advanced Usage</a><a id="Advanced-Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Advanced-Usage" title="Permalink"></a></h1><p>The most advanced features of <code>FastMultipole</code> include:</p><ul><li>the ability to solve the <span>$n$</span>-body problem for multiple systems simultaneously in a single FMM call</li><li>satisfy an error tolerance by dynamically adjusting the expansion order of multipole-to-local transformations</li><li>predict the full array of FMM tuning parameters such that an error tolerance is met</li></ul><p>In this section, we will first describe how to run the FMM for multi-system problems. Then, we will describe how to impose an error tolerance. Finally, we will show how to automatically tune the FMM parameters.</p><h2 id="Simultaneous-Computation-of-Multiple-and-Distinct-Source-and-Target-Systems"><a class="docs-heading-anchor" href="#Simultaneous-Computation-of-Multiple-and-Distinct-Source-and-Target-Systems">Simultaneous Computation of Multiple and Distinct Source and Target Systems</a><a id="Simultaneous-Computation-of-Multiple-and-Distinct-Source-and-Target-Systems-1"></a><a class="docs-heading-anchor-permalink" href="#Simultaneous-Computation-of-Multiple-and-Distinct-Source-and-Target-Systems" title="Permalink"></a></h2><p><code>FastMutipole</code> allows FMM to be performed efficiently on distinct source and target systems. This is done by creating two octrees: one for sources, and one for targets [<a href="../theory/#yokota2013fmm2">3</a>]. For example, say we desire to know the influence of one system of point masses on another, but not vice versa. This is done by passing both systems to the <code>fmm!</code> function with the target system first, as:</p><pre><code class="language-julia hljs">using FastMultipole
using Random # needed for `gravitational.jl`

gravitational_path = normpath(joinpath(splitdir(pathof(FastMultipole))[1], &quot;..&quot;, &quot;test&quot;, &quot;gravitational.jl&quot;))
include(gravitational_path)

target_system = generate_gravitational(123, 1000)
source_system = generate_gravitational(321, 1000)

fmm!(target_system, source_system)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((leaf_size_source = [20], expansion_order = 5, multipole_acceptance = 0.4), (target_buffers = ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), target_small_buffers = [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], source_buffers = ([0.1680817206353562 0.1654542810132441 … 0.9982553767377488 0.9863379826451082; 0.14899011357445868 0.2158936928680395 … 0.8971457885301007 0.9785924828365503; … ; 0.003996872851819616 0.0036424677294600266 … 0.0037184024131029477 0.001839453139237459; 0.0007831498758276411 0.00020482899866097694 … 4.702502900176131e-5 0.000553941712511201],), source_small_buffers = [[0.1680817206353562 0.1654542810132441 … 0.9982553767377488 0.9863379826451082; 0.14899011357445868 0.2158936928680395 … 0.8971457885301007 0.9785924828365503; 0.08072256741315043 0.08514054065670074 … 0.7997111340668548 0.7638187650698457]]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5001998136682482, 0.49993551265021, 0.4998270977982316], [0.5001998136682482, 0.49993551265021, 0.4998270977982316], 0.8555020311253966, 0.8555020311253966, [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[1:129], 8, 10:17, 1, -1, [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], 0.39434130204154216, 0.39434130204154216, [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[130:256], 8, 18:25, 1, -1, [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], 0.41774644436635594, 0.41774644436635594, [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[257:381], 8, 26:33, 1, -1, [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], 0.4090146201931587, 0.4090146201931587, [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[382:507], 8, 34:41, 1, -1, [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], 0.4151792260522991, 0.4151792260522991, [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[508:630], 8, 42:49, 1, -1, [0.252410143525497, 0.24949442623750556, 0.749791070728338], [0.252410143525497, 0.24949442623750556, 0.749791070728338], 0.39947385610723785, 0.39947385610723785, [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[631:757], 8, 50:57, 1, -1, [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], 0.4085722695730153, 0.4085722695730153, [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[758:886], 8, 58:65, 1, -1, [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], 0.3944024337208189, 0.3944024337208189, [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], 0.0), Branch{Float64, 1}([114], UnitRange{Int64}[887:1000], 8, 66:73, 1, -1, [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], 0.4194297904134623, 0.4194297904134623, [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[1:20], 0, 74:73, 2, 1, [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], 0.1625689130548431, 0.1625689130548431, [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], 0.0)  …  Branch{Float64, 1}([14], UnitRange{Int64}[856:869], 0, 74:73, 8, 55, [0.10644698640761496, 0.895465315438814, 0.8606218741473264], [0.10644698640761496, 0.895465315438814, 0.8606218741473264], 0.1393423281198453, 0.1393423281198453, [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[870:886], 0, 74:73, 8, 56, [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], 0.18295563489934602, 0.18295563489934602, [0.11756885838692133, 0.12131175031325891, 0.102638668058885], [0.11756885838692133, 0.12131175031325891, 0.102638668058885], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[887:900], 0, 74:73, 9, 57, [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], 0.16380301942388953, 0.16380301942388953, [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[901:910], 0, 74:73, 9, 58, [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], 0.16847619188040783, 0.16847619188040783, [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[911:926], 0, 74:73, 9, 59, [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], 0.17986540424568168, 0.17986540424568168, [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[927:938], 0, 74:73, 9, 60, [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], 0.13133480412647142, 0.13133480412647142, [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[939:952], 0, 74:73, 9, 61, [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], 0.16635596863705976, 0.16635596863705976, [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[953:970], 0, 74:73, 9, 62, [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], 0.19438037599097202, 0.19438037599097202, [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[971:982], 0, 74:73, 9, 63, [0.6321201124574805, 0.8874986817824024, 0.869152068698644], [0.6321201124574805, 0.8874986817824024, 0.869152068698644], 0.15328030111711102, 0.15328030111711102, [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], 0.1567122096012929, 0.1567122096012929, [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], 0.0)], [0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([113, 136, 154, 156, 197, 247, 253, 256, 355, 377  …  401, 423, 528, 571, 580, 588, 648, 922, 955, 998],), ([678, 508, 210, 569, 109, 477, 939, 478, 292, 631  …  869, 20, 308, 369, 725, 67, 886, 1000, 677, 171],), ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], 5, [20]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5002801383786457, 0.5003354112985055, 0.49895179027137243], [0.4999031505598644, 0.4996647236043723, 0.4989121815759741], 0.8617964118719117, 0.857511949945426, [0.502741026370014, 0.5012383247783194, 0.5015432188291886], [0.49931171360691345, 0.4990351047059004, 0.4984533186476398], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[1:129], 8, 10:17, 1, -1, [0.24688025088250481, 0.24811450837024004, 0.2464859902614924], [0.24826540247194434, 0.2465476200590372, 0.24533347562121322], 0.39939075734331, 0.3976734554539909, [0.24934113887387316, 0.24772071132210363, 0.2472726711728103], [0.24703547839297962, 0.24559827521088107, 0.2442870703187887], 0.0), Branch{Float64, 1}([124], UnitRange{Int64}[130:253], 8, 18:25, 1, -1, [0.7484245143391739, 0.2505532114354905, 0.2465208775924886], [0.7491289474362203, 0.250259538761477, 0.24762432176159366], 0.4285665140518957, 0.4245430913132316, [0.24972558883408902, 0.25145612491530456, 0.24911230615030486], [0.24590141659964382, 0.24894798702187326, 0.24626786454258676], 0.0), Branch{Float64, 1}([122], UnitRange{Int64}[254:375], 8, 26:33, 1, -1, [0.247635700077781, 0.7507520037583586, 0.24931087115058606], [0.24693184877704077, 0.7516811422555818, 0.24765132534801998], 0.41020211026110104, 0.4053908061351539, [0.24924598129242034, 0.24939572599604043, 0.2453946478904567], [0.24501849052206703, 0.24583237397452873, 0.24254320708926508], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[376:502], 8, 34:41, 1, -1, [0.7459596766240476, 0.7481705292993521, 0.2492836928342803], [0.7451334781054144, 0.7478584740272267, 0.24816982000748378], 0.4037903774782307, 0.39847498663753383, [0.24680700609678174, 0.2524588577711617, 0.25146711706955127], [0.24286929632618126, 0.24801601129781992, 0.24771095707914947], 0.0), Branch{Float64, 1}([146], UnitRange{Int64}[503:648], 8, 42:49, 1, -1, [0.24734232538491302, 0.2521669062709989, 0.7495988575817394], [0.24773490483311922, 0.25212169160128206, 0.7483838962581912], 0.4064191743703888, 0.4059402613230175, [0.24547113165231438, 0.2490736484967312, 0.2508961515188217], [0.2450254745912086, 0.24752510555478058, 0.24898160396542268], 0.0), Branch{Float64, 1}([115], UnitRange{Int64}[649:763], 8, 50:57, 1, -1, [0.7538509500098973, 0.24232023464373947, 0.7463435438012155], [0.7530076326914124, 0.24184455802199845, 0.7472427468193403], 0.41282232063924684, 0.41162399422411744, [0.24917021473876244, 0.24254131529074086, 0.25145787886829696], [0.2462072314753655, 0.24121493912352654, 0.24819118468497203], 0.0), Branch{Float64, 1}([107], UnitRange{Int64}[764:870], 8, 58:65, 1, -1, [0.24659423792547602, 0.7495556873200975, 0.7484985294109381], [0.24677477539716508, 0.7504367194319057, 0.7481212718221815], 0.41739830202765904, 0.4156111484455347, [0.24812551433041463, 0.2520180487567274, 0.2478089664585028], [0.24618333844421414, 0.248263108878367, 0.24588280765200943], 0.0), Branch{Float64, 1}([130], UnitRange{Int64}[871:1000], 8, 66:73, 1, -1, [0.7486993100701869, 0.7462445123398274, 0.750904712130983], [0.7491031089465416, 0.7454154904233052, 0.7504531893707469], 0.41247050546167574, 0.41014423267841604, [0.25327446908066475, 0.24744088967247946, 0.2485151563317568], [0.24915226779120714, 0.24571355147786844, 0.24469385123306842], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[1:20], 0, 74:73, 2, 1, [0.11588500014305983, 0.12691036266156575, 0.1290753578250018], [0.11743560482116239, 0.12599227639940996, 0.1307635709885358], 0.18552670026993587, 0.18286040802903142, [0.11834588813442815, 0.12527901736303704, 0.10221439284556497], [0.11620568074219767, 0.12400383601298043, 0.10016908459413015], 0.0)  …  Branch{Float64, 1}([16], UnitRange{Int64}[839:854], 0, 74:73, 8, 55, [0.12203686536239934, 0.8775450558010859, 0.8618590916874411], [0.12269587125065845, 0.8783112604081367, 0.8621706264142543], 0.1900716168937807, 0.188648761925676, [0.12356814176733798, 0.10819482109164114, 0.11595395883816884], [0.12210443429770751, 0.10683831234080243, 0.11183546898954166], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[855:870], 0, 74:73, 8, 56, [0.3804339724986709, 0.870955590503702, 0.8601288808497978], [0.38160122541471103, 0.8704748611168164, 0.8614138381151137], 0.19324510336856224, 0.18976357422287338, [0.11428577975721976, 0.12295348130662398, 0.11163175821687032], [0.11135688842666819, 0.12001238996906138, 0.1088205712355943], 0.0), Branch{Float64, 1}([15], UnitRange{Int64}[871:885], 0, 74:73, 9, 57, [0.6195434686324706, 0.6284739843620084, 0.6303191639112993], [0.620949088087971, 0.6288039808776781, 0.6317319527293332], 0.17471867792785664, 0.17154577420699516, [0.12411862764294856, 0.11643311447255444, 0.11684025619938254], [0.1209982469326365, 0.11281828237113112, 0.11371270612653694], 0.0), Branch{Float64, 1}([15], UnitRange{Int64}[886:900], 0, 74:73, 9, 58, [0.8499290765983789, 0.6242169585253596, 0.6282440627003549], [0.851155479237456, 0.6235149063261094, 0.6289987412311444], 0.17763456865211416, 0.17686396286761513, [0.0953671773268322, 0.11670418509453617, 0.11882533310936527], [0.09413377484948182, 0.11294412671278364, 0.11693298401211838], 0.0), Branch{Float64, 1}([25], UnitRange{Int64}[901:925], 0, 74:73, 9, 59, [0.6263637002009707, 0.8613814323304474, 0.6064876993312366], [0.6274981399998526, 0.8619956369780051, 0.607211017980211], 0.19093318270769458, 0.18901752984061734, [0.12428082834709064, 0.11499274291799655, 0.10409814353201041], [0.12204548580752028, 0.1125048425961741, 0.10145167984253267], 0.0), Branch{Float64, 1}([19], UnitRange{Int64}[926:944], 0, 74:73, 9, 60, [0.8661732217589185, 0.8709419316809688, 0.6305800398476511], [0.8666916752555875, 0.8713932207378678, 0.6306113822087636], 0.18516239141485857, 0.18220223088373058, [0.11064822022848508, 0.12274347033133803, 0.11710586986366955], [0.1070817144487709, 0.11973582116330583, 0.11360459854748017], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[945:956], 0, 74:73, 9, 61, [0.6077595371647055, 0.6222370566824301, 0.860102694284743], [0.6080934148023404, 0.6207186375694569, 0.8594333242270378], 0.16020076489380486, 0.15510016992797496, [0.08487370933515226, 0.12343343401508211, 0.1045931066088428], [0.08098800632166525, 0.1210166986240202, 0.10154875589545664], 0.0), Branch{Float64, 1}([19], UnitRange{Int64}[957:975], 0, 74:73, 9, 62, [0.8731739017919118, 0.6235046296912206, 0.8550843389090829], [0.8738148298288648, 0.6233436220460993, 0.8571190553237932], 0.16464574676502794, 0.1622084905977449, [0.11748618011349499, 0.12018175392447528, 0.1037052690511473], [0.1160868118568762, 0.11703052772359179, 0.10091211241677123], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[976:995], 0, 74:73, 9, 63, [0.6160021686105288, 0.8747851666485041, 0.8865902056098074], [0.6149209544619931, 0.8738595711557045, 0.8845345939048264], 0.15795089372150914, 0.15590914714880513, [0.1137076130232666, 0.11149049799422739, 0.11282966285293239], [0.11127349040034973, 0.10814326562810261, 0.11061244669898895], 0.0), Branch{Float64, 1}([5], UnitRange{Int64}[996:1000], 0, 74:73, 9, 64, [0.8753732884370313, 0.9326357857142328, 0.8604860828432261], [0.8749859507449625, 0.9331879226590967, 0.8599843466845012], 0.15601387286113602, 0.1539761935510942, [0.1266004907138203, 0.04779615026155504, 0.09850677091261784], [0.12326942599278623, 0.045404560177453646, 0.09616558161465538], 0.0)], [-0.4958683029231835 0.0; 0.0 0.0;;; -0.000960396351275726 0.0; 0.0 0.0;;; -0.004866708283319176 0.0; -0.0030433348144678057 0.0;;; … ;;; 2.822320103425996e-6 0.0; -8.92496385684247e-7 0.0;;; 2.663782082686518e-7 0.0; -2.951622573194448e-7 0.0;;; 3.285084678680605e-8 0.0; 3.261389820072249e-8 0.0;;;; -0.06234246368052235 0.0; 0.0 0.0;;; 0.0001227833719853631 0.0; 0.0 0.0;;; -9.538942866960982e-5 0.0; 7.951030755077307e-5 0.0;;; … ;;; -9.274268688256359e-10 0.0; 4.49719134089947e-10 0.0;;; -7.648895994749992e-9 0.0; 5.542028670821691e-9 0.0;;; -1.3019735229398402e-9 0.0; 2.1587407636835066e-10 0.0;;;; -0.059664181634692816 0.0; 0.0 0.0;;; -0.0009638596518519648 0.0; 0.0 0.0;;; -0.0003021799417394491 0.0; 0.00013597462015508622 0.0;;; … ;;; -4.936809429680647e-9 0.0; 8.650111109428088e-9 0.0;;; -5.291589594261279e-10 0.0; -5.312891890171337e-9 0.0;;; -3.0514981024217254e-10 0.0; 1.2300663733137102e-9 0.0;;;; … ;;;; -0.008065308374170395 0.0; 0.0 0.0;;; -2.077094518408679e-6 0.0; 0.0 0.0;;; 5.4137287954606876e-5 0.0; -0.0001031510654799755 0.0;;; … ;;; 3.017560407702907e-11 0.0; -2.2671982928728085e-11 0.0;;; -2.2641721065418358e-11 0.0; -1.7339313160025986e-11 0.0;;; -9.761450403521905e-12 0.0; 8.94240933135891e-12 0.0;;;; -0.00893204384513729 0.0; 0.0 0.0;;; 2.669518180873595e-5 0.0; 0.0 0.0;;; -0.00014653012898641331 0.0; 6.937864797765562e-5 0.0;;; … ;;; 1.1302708352847569e-10 0.0; 7.890494576718845e-11 0.0;;; -6.135414793485474e-11 0.0; -7.905937129881897e-11 0.0;;; 7.639057501285317e-12 0.0; 8.428645347063394e-12 0.0;;;; -0.0026686679569717085 0.0; 0.0 0.0;;; -7.522137137483243e-5 0.0; 0.0 0.0;;; -2.5982701030521552e-5 0.0; -5.319454885632655e-5 0.0;;; … ;;; -2.967287071759751e-11 0.0; -8.90803597507283e-12 0.0;;; -8.576978020890714e-12 0.0; 2.960615696827563e-11 0.0;;; -9.500400428257548e-12 0.0; 1.06532368300902e-12 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([77, 80, 87, 122, 338, 360, 367, 416, 457, 466  …  738, 801, 843, 844, 886, 150, 298, 930, 948, 980],), ([778, 717, 649, 976, 633, 886, 120, 433, 701, 570  …  316, 681, 611, 682, 360, 425, 426, 632, 783, 870],), ([0.1680817206353562 0.1654542810132441 … 0.9982553767377488 0.9863379826451082; 0.14899011357445868 0.2158936928680395 … 0.8971457885301007 0.9785924828365503; … ; 0.003996872851819616 0.0036424677294600266 … 0.0037184024131029477 0.001839453139237459; 0.0007831498758276411 0.00020482899866097694 … 4.702502900176131e-5 0.000553941712511201],), [[0.1680817206353562 0.1654542810132441 … 0.9982553767377488 0.9863379826451082; 0.14899011357445868 0.2158936928680395 … 0.8971457885301007 0.9785924828365503; 0.08072256741315043 0.08514054065670074 … 0.7997111340668548 0.7638187650698457]], 5, [20]), StaticArraysCore.SVector{2, Int32}[], StaticArraysCore.SVector{2, Int32}[[10, 10], [10, 11], [10, 12], [10, 13], [10, 14], [10, 15], [10, 16], [10, 17], [10, 18], [10, 19]  …  [73, 64], [73, 65], [73, 66], [73, 67], [73, 68], [73, 69], [73, 70], [73, 71], [73, 72], [73, 73]], (DerivativesSwitch{false, true, false}(),), true)</code></pre><p>In practice, the source system might be a collection of systems, composed of a variety of datastructures. So long as the interface functions are defined for each system, we can pass a tuple of any number of systems as the source and or target. For example, we could evaluate the influence of a system of point masses, point vortices, and vortex filaments on two different target systems:</p><pre><code class="language-julia hljs">using LinearAlgebra

# include vortex filament and particle models and interface functions
vortex_path = normpath(joinpath(splitdir(pathof(FastMultipole))[1], &quot;..&quot;, &quot;test&quot;, &quot;vortex.jl&quot;))
include(vortex_path)
filament_path = normpath(joinpath(splitdir(pathof(FastMultipole))[1], &quot;..&quot;, &quot;test&quot;, &quot;vortex_filament.jl&quot;))
include(filament_path)

# generate systems
n_bodies = 2000
target_one = generate_gravitational(123, n_bodies)
target_two = generate_vortex(124, n_bodies)
source_one = generate_gravitational(125, n_bodies)
source_two = generate_vortex(126, n_bodies)
source_three = generate_filament_field(n_bodies, n_bodies^0.333, 127; strength_scale=1/n_bodies)

# run FMM
fmm!((target_one, target_two), (source_one, source_two, source_three); lamb_helmholtz=true,
    scalar_potential=false, gradient=true, hessian=(false, true))

v1 = target_one.potential[5:7,:]
v2 = target_two.gradient_stretching[1:3,:]

# run direct
target_one.potential .= 0.0
target_two.potential .= 0.0
target_two.gradient_stretching .= 0.0
direct!((target_one, target_two), (source_one, source_two, source_three); scalar_potential=false, gradient=true, hessian=(false, true))

# test accuracy
println(&quot;Max error in target one: &quot;, maximum(abs.(target_one.potential[5:7,:] .- v1)))
println(&quot;Max error in target two: &quot;, maximum(abs.(target_two.gradient_stretching[1:3,:] .- v2)))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Max error in target one: 1.4007503612439853e-5
Max error in target two: 1.0289615966441179e-5</code></pre><p>Note that <code>scalar_potential</code>, <code>gradient</code>, and <code>hessian</code> can be passed as a single boolean or as a tuple of booleans, one for each target system. This allows the user to specify which values are desired for each target system, and avoids unnecessary calculations for values that are not needed. In this case, we have set <code>scalar_potential=false</code> and <code>gradient=true</code> to indicate all target systems, but a tuple <code>hessian=(false,true)</code> to indicate different settings for each. It is worth remembering that these switches must be implemented by the user when overloading the <code>direct!</code> function for each system to act as a source.</p><h2 id="Satisfying-an-Error-Tolerance"><a class="docs-heading-anchor" href="#Satisfying-an-Error-Tolerance">Satisfying an Error Tolerance</a><a id="Satisfying-an-Error-Tolerance-1"></a><a class="docs-heading-anchor-permalink" href="#Satisfying-an-Error-Tolerance" title="Permalink"></a></h2><p><code>FastMultipole</code> can be configured to satisfy an error tolerance by dynamically adjusting the expansion order of each multipole-to-local transformation to the smallest integer that satisfies the tolerance, according to an error prediction. Users can indicate their desired error tolerance via the keyword argument <code>ε_tol</code> in the <code>fmm!</code> function. A value of <code>nothing</code> indicates no error tolerance, in which case the expansion order is fixed at whatever is passed as the <code>expansion_order</code> keyword. Otherwise, <code>ε_tol</code> should inherit from the <code>ErrorMethod</code> abstract type. The chosen type will determine how the error is predicted, and hence how the expansion order is chosen. Choices include:</p><ul><li><code>PowerAbsolutePotential{tolerance}</code>: Constrains the magnitude of the potential error to be less than <code>tolerance</code> using a radially invariant upper bound.</li><li><code>PowerAbsoluteGradient{tolerance}</code>: Constrains the magnitude of the vector field error to be less than <code>tolerance</code> using a radially invariant upper bound.</li><li><code>PowerRelativePotential{tolerance}</code>: Constrains the relative error of the potential to be less than <code>tolerance</code> using a radially invariant upper bound.</li><li><code>PowerRelativeGradient{tolerance}</code>: Constrains the relative error of the vector field to be less than <code>tolerance</code> using a radially invariant upper bound.</li></ul><p>Say I wanted to compute the gravitational potential to a tolerance of <code>1e-4</code> using the absolute potential error method. I would call the FMM as follows:</p><pre><code class="language-julia hljs"># create system
n_bodies, rand_seed = 50_000, 123
system = generate_gravitational(rand_seed, n_bodies)

# run FMM with error tolerance
fmm!(system; lamb_helmholtz=false, scalar_potential=true, gradient=false, hessian=false, ε_tol=PowerAbsolutePotential(1e-4))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((leaf_size_source = [20], expansion_order = 5, multipole_acceptance = 0.4), (target_buffers = ([0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), target_small_buffers = [[0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; 0.05681388716981173 0.021771321079524175 … 0.9840514906123553 0.9647137671851761]], source_buffers = ([0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; … ; 6.453930575067661e-6 0.000530235313349985 … 0.0010983597791527128 0.0007526951297042993; 1.875345041569765e-5 1.3974956481239035e-5 … 1.782131317352117e-5 7.357874501731705e-6],), source_small_buffers = [[0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; 0.05681388716981173 0.021771321079524175 … 0.9840514906123553 0.9647137671851761]]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([50000], UnitRange{Int64}[1:50000], 8, 2:9, 0, -1, [0.500021341014919, 0.49999836275668424, 0.4999979175074065], [0.500021341014919, 0.49999836275668424, 0.4999979175074065], 0.8666161204644457, 0.8666161204644457, [0.49997167827457845, 0.49999427777043043, 0.49995598836015676], [0.49997167827457845, 0.49999427777043043, 0.49995598836015676], 0.0), Branch{Float64, 1}([6360], UnitRange{Int64}[1:6360], 8, 10:17, 1, -1, [0.2500467959782027, 0.2500163095770938, 0.24974609061024905], [0.2500467959782027, 0.2500163095770938, 0.24974609061024905], 0.43107612211791524, 0.43107612211791524, [0.24988015327279312, 0.24997460211392447, 0.2496860266062096], [0.24988015327279312, 0.24997460211392447, 0.2496860266062096], 0.0), Branch{Float64, 1}([6364], UnitRange{Int64}[6361:12724], 8, 18:25, 1, -1, [0.7500474286242338, 0.24997382708276367, 0.25001536977432326], [0.7500474286242338, 0.24997382708276367, 0.25001536977432326], 0.4320568816591209, 0.4320568816591209, [0.24992715715326252, 0.24996974209650985, 0.2499734406270735], [0.24992715715326252, 0.24996974209650985, 0.2499734406270735], 0.0), Branch{Float64, 1}([6048], UnitRange{Int64}[12725:18772], 8, 26:33, 1, -1, [0.24992199959691236, 0.7499330518166033, 0.25008801598767966], [0.24992199959691236, 0.7499330518166033, 0.25008801598767966], 0.43128281553622816, 0.43128281553622816, [0.2498723368565718, 0.24992800567487872, 0.24986183907855325], [0.2498723368565718, 0.24992800567487872, 0.24986183907855325], 0.0), Branch{Float64, 1}([6136], UnitRange{Int64}[18773:24908], 8, 34:41, 1, -1, [0.7500720392953337, 0.7499743305579387, 0.24996255759311115], [0.7500720392953337, 0.7499743305579387, 0.24996255759311115], 0.43069249597045767, 0.43069249597045767, [0.24992097999416374, 0.24990522252317204, 0.24988904627599506], [0.24992097999416374, 0.24990522252317204, 0.24988904627599506], 0.0), Branch{Float64, 1}([6182], UnitRange{Int64}[24909:31090], 8, 42:49, 1, -1, [0.2503108157163493, 0.24999963088119193, 0.750020039308819], [0.2503108157163493, 0.24999963088119193, 0.750020039308819], 0.4313103967770774, 0.4313103967770774, [0.2496629047458533, 0.2499834958568442, 0.24988110081428994], [0.2496629047458533, 0.2499834958568442, 0.24988110081428994], 0.0), Branch{Float64, 1}([6296], UnitRange{Int64}[31091:37386], 8, 50:57, 1, -1, [0.7499631713346686, 0.2500290749163813, 0.7499252514340624], [0.7499631713346686, 0.2500290749163813, 0.7499252514340624], 0.4314993166622842, 0.4314993166622842, [0.2498899297677376, 0.2499643048992704, 0.2498554770963014], [0.2498899297677376, 0.2499643048992704, 0.2498554770963014], 0.0), Branch{Float64, 1}([6296], UnitRange{Int64}[37387:43682], 8, 58:65, 1, -1, [0.2500669314479764, 0.7501608352872271, 0.7499995952500497], [0.2500669314479764, 0.7501608352872271, 0.7499995952500497], 0.4335349405469966, 0.4335349405469966, [0.2498860188460178, 0.24983180523988757, 0.2499543106175136], [0.2498860188460178, 0.24983180523988757, 0.2499543106175136], 0.0), Branch{Float64, 1}([6318], UnitRange{Int64}[43683:50000], 8, 66:73, 1, -1, [0.7500446227722513, 0.7499938229205292, 0.7499575899349928], [0.7500446227722513, 0.7499938229205292, 0.7499575899349928], 0.43174221884909925, 0.43174221884909925, [0.24990677952238427, 0.24981409178897496, 0.2498795123800931], [0.24990677952238427, 0.24981409178897496, 0.2498795123800931], 0.0), Branch{Float64, 1}([751], UnitRange{Int64}[1:751], 8, 74:81, 2, -1, [0.1253394121219879, 0.1248107086177041, 0.1252773659712677], [0.1253394121219879, 0.1248107086177041, 0.1252773659712677], 0.209893342167243, 0.209893342167243, [0.12451984209218775, 0.12460074932548287, 0.12427027078924979], [0.12451984209218775, 0.12460074932548287, 0.12427027078924979], 0.0)  …  Branch{Float64, 1}([15], UnitRange{Int64}[49887:49901], 0, 4682:4681, 584, 4087, [0.7770421311275272, 0.9657791580483186, 0.9684328205551082], [0.7770421311275272, 0.9657791580483186, 0.9684328205551082], 0.04345992043295624, 0.04345992043295624, [0.024340927728118245, 0.028110502813465277, 0.03005526025680516], [0.024340927728118245, 0.028110502813465277, 0.03005526025680516], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[49902:49915], 0, 4682:4681, 584, 4088, [0.8449365170706529, 0.9677183590731353, 0.9689855607245921], [0.8449365170706529, 0.9677183590731353, 0.9689855607245921], 0.044991635218921626, 0.044991635218921626, [0.028494257538852596, 0.025425180561123084, 0.028647110648439722], [0.028494257538852596, 0.025425180561123084, 0.028647110648439722], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[49916:49925], 0, 4682:4681, 585, 4089, [0.9086871885121199, 0.9051776233953437, 0.9104221276829746], [0.9086871885121199, 0.9051776233953437, 0.9104221276829746], 0.039170832990678334, 0.039170832990678334, [0.023006596836877002, 0.028469480722009943, 0.02598762724843895], [0.023006596836877002, 0.028469480722009943, 0.02598762724843895], 0.0), Branch{Float64, 1}([9], UnitRange{Int64}[49926:49934], 0, 4682:4681, 585, 4090, [0.9725943260965962, 0.9058376039482596, 0.9033523958088556], [0.9725943260965962, 0.9058376039482596, 0.9033523958088556], 0.04543487249442245, 0.04543487249442245, [0.02633021318101192, 0.03014008710953664, 0.028327646855026756], [0.02633021318101192, 0.03014008710953664, 0.028327646855026756], 0.0), Branch{Float64, 1}([9], UnitRange{Int64}[49935:49943], 0, 4682:4681, 585, 4091, [0.9060062265544926, 0.9660861415655537, 0.9064650670218193], [0.9060062265544926, 0.9660861415655537, 0.9064650670218193], 0.047432593339173226, 0.047432593339173226, [0.030043167570476426, 0.023419124837430028, 0.030685542784685937], [0.030043167570476426, 0.023419124837430028, 0.030685542784685937], 0.0), Branch{Float64, 1}([8], UnitRange{Int64}[49944:49951], 0, 4682:4681, 585, 4092, [0.9653521772078217, 0.9719171708358517, 0.9083385343027235], [0.9653521772078217, 0.9719171708358517, 0.9083385343027235], 0.03709287809846188, 0.03709287809846188, [0.022741450914241956, 0.016880044936635086, 0.023953540424740072], [0.022741450914241956, 0.016880044936635086, 0.023953540424740072], 0.0), Branch{Float64, 1}([15], UnitRange{Int64}[49952:49966], 0, 4682:4681, 585, 4093, [0.9055667484364489, 0.9048290408445401, 0.9690637219990402], [0.9055667484364489, 0.9048290408445401, 0.9690637219990402], 0.043744348377588886, 0.043744348377588886, [0.030309765761853846, 0.028327461569269352, 0.02906132680469864], [0.030309765761853846, 0.028327461569269352, 0.02906132680469864], 0.0), Branch{Float64, 1}([9], UnitRange{Int64}[49967:49975], 0, 4682:4681, 585, 4094, [0.9734273210205616, 0.9040190066280985, 0.9721551045172485], [0.9734273210205616, 0.9040190066280985, 0.9721551045172485], 0.041846230474696315, 0.041846230474696315, [0.02495597763382207, 0.02525095727602844, 0.026393713532650076], [0.02495597763382207, 0.02525095727602844, 0.026393713532650076], 0.0), Branch{Float64, 1}([8], UnitRange{Int64}[49976:49983], 0, 4682:4681, 585, 4095, [0.9072790433733581, 0.9644428341224451, 0.9688019738064739], [0.9072790433733581, 0.9644428341224451, 0.9688019738064739], 0.040220896683822824, 0.040220896683822824, [0.027163675530304854, 0.023745058576119193, 0.024027673647543324], [0.027163675530304854, 0.023745058576119193, 0.024027673647543324], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[49984:50000], 0, 4682:4681, 585, 4096, [0.969806818974307, 0.9677818556453532, 0.9651313380168189], [0.969806818974307, 0.9677818556453532, 0.9651313380168189], 0.045505017587529964, 0.045505017587529964, [0.02890531888213732, 0.02986370606018196, 0.02661225295212477], [0.02890531888213732, 0.02986370606018196, 0.02661225295212477], 0.0)], [0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; … ;;;; -0.5631652637302175 0.0; -1.2746305805190083e-20 0.0;;; -0.384696838148787 0.0; 0.0 0.0;;; -0.38272232336510026 0.0; -0.38590858580607307 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; -0.563962633247191 0.0; -9.441671873925484e-21 0.0;;; -0.38693494976402576 0.0; 0.0 0.0;;; -0.3941101097820996 0.0; -0.3760711575183535 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; -0.5426679964523891 0.0; -2.5910607097462233e-21 0.0;;; -0.37739154565479666 0.0; 0.0 0.0;;; -0.38755451624202913 0.0; -0.3794458640154912 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0], UnitRange{Int64}[1:1, 2:9, 10:73, 74:585, 586:4681], [586, 587, 588, 589, 590, 591, 592, 593, 594, 595  …  4672, 4673, 4674, 4675, 4676, 4677, 4678, 4679, 4680, 4681], ([4451, 4672, 8289, 14431, 28345, 34749, 35261, 36248, 41762, 44140  …  23515, 25182, 25715, 27912, 28744, 29131, 38267, 42992, 46335, 49303],), ([34221, 25573, 10506, 28227, 5964, 24088, 47163, 23447, 14686, 31641  …  37274, 31518, 11617, 33099, 36752, 13299, 22380, 44294, 11274, 40937],), ([0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), [[0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; 0.05681388716981173 0.021771321079524175 … 0.9840514906123553 0.9647137671851761]], 5, [20]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([50000], UnitRange{Int64}[1:50000], 8, 2:9, 0, -1, [0.5000444626654784, 0.499994869466017, 0.5000618838062153], [0.500021341014919, 0.49999836275668424, 0.4999979175074065], 0.867222056634364, 0.8666161204644457, [0.5011397658145614, 0.5009395927119438, 0.5011182891475078], [0.49997167827457845, 0.49999427777043043, 0.49995598836015676], 0.0), Branch{Float64, 1}([6360], UnitRange{Int64}[1:6360], 8, 10:17, 1, -1, [0.2500804455087341, 0.2498500240986926, 0.24967887684997458], [0.2500467959782027, 0.2500163095770938, 0.24974609061024905], 0.4314936123655788, 0.43107612211791524, [0.25054999678448053, 0.25077368380353504, 0.25073528219126706], [0.24988015327279312, 0.24997460211392447, 0.2496860266062096], 0.0), Branch{Float64, 1}([6364], UnitRange{Int64}[6361:12724], 8, 18:25, 1, -1, [0.7501095467960952, 0.2501529315296385, 0.25024084099395233], [0.7500474286242338, 0.24997382708276367, 0.25001536977432326], 0.4332714583958306, 0.4320568816591209, [0.25082156759266816, 0.25089199026532355, 0.2510649670300929], [0.24992715715326252, 0.24996974209650985, 0.2499734406270735], 0.0), Branch{Float64, 1}([6048], UnitRange{Int64}[12725:18772], 8, 26:33, 1, -1, [0.24983121741189587, 0.7497467106660736, 0.25018296593548167], [0.24992199959691236, 0.7499330518166033, 0.25008801598767966], 0.4319603513785806, 0.43128281553622816, [0.25092652056097897, 0.2506835143710986, 0.250875301580382], [0.2498723368565718, 0.24992800567487872, 0.24986183907855325], 0.0), Branch{Float64, 1}([6136], UnitRange{Int64}[18773:24908], 8, 34:41, 1, -1, [0.7500383724761999, 0.7500426228926866, 0.2499972006369791], [0.7500720392953337, 0.7499743305579387, 0.24996255759311115], 0.4314087722064627, 0.43069249597045767, [0.25112060687077964, 0.25072704255644007, 0.25088824687988326], [0.24992097999416374, 0.24990522252317204, 0.24988904627599506], 0.0), Branch{Float64, 1}([6182], UnitRange{Int64}[24909:31090], 8, 42:49, 1, -1, [0.25045915859256584, 0.25003944726293614, 0.7501011561523943], [0.2503108157163493, 0.24999963088119193, 0.750020039308819], 0.4324024353330733, 0.4313103967770774, [0.2504419706075781, 0.2509841705088629, 0.2510790168013288], [0.2496629047458533, 0.2499834958568442, 0.24988110081428994], 0.0), Branch{Float64, 1}([6296], UnitRange{Int64}[31091:37386], 8, 50:57, 1, -1, [0.7499508340535059, 0.2501227041308239, 0.7501830646900072], [0.7499631713346686, 0.2500290749163813, 0.7499252514340624], 0.4321740279522337, 0.4314993166622842, [0.2511300533111851, 0.2509709673666663, 0.25064392245258604], [0.2498899297677376, 0.2499643048992704, 0.2498554770963014], 0.0), Branch{Float64, 1}([6296], UnitRange{Int64}[37387:43682], 8, 58:65, 1, -1, [0.2500507090049674, 0.750217381267631, 0.7497915191168183], [0.2500669314479764, 0.7501608352872271, 0.7499995952500497], 0.4342404484407274, 0.4335349405469966, [0.25091640686418004, 0.25071708091032974, 0.25096921364686176], [0.2498860188460178, 0.24983180523988757, 0.2499543106175136], 0.0), Branch{Float64, 1}([6318], UnitRange{Int64}[43683:50000], 8, 66:73, 1, -1, [0.7502866558613374, 0.74992349442938, 0.7500580732808934], [0.7500446227722513, 0.7499938229205292, 0.7499575899349928], 0.43307760120778616, 0.43174221884909925, [0.2508975726187025, 0.25072057309130935, 0.2509920156862234], [0.24990677952238427, 0.24981409178897496, 0.2498795123800931], 0.0), Branch{Float64, 1}([751], UnitRange{Int64}[1:751], 8, 74:81, 2, -1, [0.12537593959087057, 0.12480449582638206, 0.12520433079477641], [0.1253394121219879, 0.1248107086177041, 0.1252773659712677], 0.21096025081620504, 0.209893342167243, [0.125187795856755, 0.1257281555312245, 0.12517117672787045], [0.12451984209218775, 0.12460074932548287, 0.12427027078924979], 0.0)  …  Branch{Float64, 1}([15], UnitRange{Int64}[49887:49901], 0, 4682:4681, 584, 4087, [0.777357859353301, 0.9657395270861053, 0.9681170923293343], [0.7770421311275272, 0.9657791580483186, 0.9684328205551082], 0.04508458398904587, 0.04345992043295624, [0.025048409766961877, 0.028625139028487734, 0.030762742295648904], [0.024340927728118245, 0.028110502813465277, 0.03005526025680516], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[49902:49915], 0, 4682:4681, 584, 4088, [0.8451609730594679, 0.9676829686470596, 0.968906003305608], [0.8449365170706529, 0.9677183590731353, 0.9689855607245921], 0.04603313935560371, 0.044991635218921626, [0.029323396524980838, 0.026514165962142067, 0.029759159374772026], [0.028494257538852596, 0.025425180561123084, 0.028647110648439722], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[49916:49925], 0, 4682:4681, 585, 4089, [0.9082078369661915, 0.9051855570465475, 0.9104405246310237], [0.9086871885121199, 0.9051776233953437, 0.9104221276829746], 0.039751733823221044, 0.039170832990678334, [0.023771167824953254, 0.028762633815361482, 0.02725965321319579], [0.023006596836877002, 0.028469480722009943, 0.02598762724843895], 0.0), Branch{Float64, 1}([9], UnitRange{Int64}[49926:49934], 0, 4682:4681, 585, 4090, [0.97235420115413, 0.9058595583449587, 0.9031988724798284], [0.9725943260965962, 0.9058376039482596, 0.9033523958088556], 0.04620059054266368, 0.04543487249442245, [0.027254187976117228, 0.030845891358874944, 0.02890188217203693], [0.02633021318101192, 0.03014008710953664, 0.028327646855026756], 0.0), Branch{Float64, 1}([9], UnitRange{Int64}[49935:49943], 0, 4682:4681, 585, 4091, [0.9057533600767307, 0.9657339958681512, 0.9067954862779259], [0.9060062265544926, 0.9660861415655537, 0.9064650670218193], 0.04778815291865156, 0.047432593339173226, [0.030362038525139856, 0.023959591137606817, 0.03104979657595386], [0.030043167570476426, 0.023419124837430028, 0.030685542784685937], 0.0), Branch{Float64, 1}([8], UnitRange{Int64}[49944:49951], 0, 4682:4681, 585, 4092, [0.9656472502232825, 0.9720236738213456, 0.908543568530062], [0.9653521772078217, 0.9719171708358517, 0.9083385343027235], 0.03790606715069889, 0.03709287809846188, [0.023487805347539692, 0.01743782933996585, 0.024609856069915614], [0.022741450914241956, 0.016880044936635086, 0.023953540424740072], 0.0), Branch{Float64, 1}([15], UnitRange{Int64}[49952:49966], 0, 4682:4681, 585, 4093, [0.9050553460984518, 0.9049307669585895, 0.9691206959871892], [0.9055667484364489, 0.9048290408445401, 0.9690637219990402], 0.04415431747452549, 0.043744348377588886, [0.030904816374274446, 0.029546573873363124, 0.02964643855475313], [0.030309765761853846, 0.028327461569269352, 0.02906132680469864], 0.0), Branch{Float64, 1}([9], UnitRange{Int64}[49967:49975], 0, 4682:4681, 585, 4094, [0.9733124659358178, 0.9041338617128424, 0.9720588298891308], [0.9734273210205616, 0.9040190066280985, 0.9721551045172485], 0.04193854210618717, 0.041846230474696315, [0.025122200366393344, 0.025417180008599716, 0.026978438100732638], [0.02495597763382207, 0.02525095727602844, 0.026393713532650076], 0.0), Branch{Float64, 1}([8], UnitRange{Int64}[49976:49983], 0, 4682:4681, 585, 4095, [0.9069125853870321, 0.9640319305204555, 0.9693231101979629], [0.9072790433733581, 0.9644428341224451, 0.9688019738064739], 0.041317520692315944, 0.040220896683822824, [0.027905665378362365, 0.02453149403984034, 0.024704481506515275], [0.027163675530304854, 0.023745058576119193, 0.024027673647543324], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[49984:50000], 0, 4682:4681, 585, 4096, [0.9700129059555753, 0.9674244849710179, 0.965215364277231], [0.969806818974307, 0.9677818556453532, 0.9651313380168189], 0.04611572625876103, 0.045505017587529964, [0.029905813865638065, 0.03050893008159028, 0.027497004353889798], [0.02890531888213732, 0.02986370606018196, 0.02661225295212477], 0.0)], [-0.4986708593791209 0.0; 0.0 0.0;;; -0.00040377137408762094 0.0; 0.0 0.0;;; -0.0004534360679634541 0.0; 0.0008095137456400944 0.0;;; … ;;; 7.956099229578486e-8 0.0; -8.296313349616806e-8 0.0;;; 1.712347570542761e-8 0.0; 4.929461753502429e-8 0.0;;; -1.5312187356487238e-8 0.0; 5.671035673982905e-9 0.0;;;; -0.06309699139816102 0.0; 0.0 0.0;;; -0.0001312776489683469 0.0; 0.0 0.0;;; 9.406422820147815e-6 0.0; 0.00013172864749119202 0.0;;; … ;;; 5.013581737339751e-10 0.0; 3.8879101175063364e-9 0.0;;; -1.0270518791822722e-9 0.0; 2.17996932245829e-10 0.0;;; 2.6687642640732726e-10 0.0; -2.4306213023308085e-10 0.0;;;; -0.06379985550205737 0.0; 0.0 0.0;;; -0.00014629072320246415 0.0; 0.0 0.0;;; 2.038180986256425e-5 0.0; 6.775630189935646e-5 0.0;;; … ;;; 2.1086650662604803e-9 0.0; 5.513708026770763e-10 0.0;;; 5.767500439057399e-11 0.0; -9.15143565150165e-10 0.0;;; 2.628015291738219e-10 0.0; -2.44168649093413e-10 0.0;;;; … ;;;; -0.00010950120792711721 0.0; 0.0 0.0;;; 6.570009872359731e-7 0.0; 0.0 0.0;;; -8.32205821636116e-8 0.0; -6.349086264260722e-7 0.0;;; … ;;; -1.8548524819401988e-15 0.0; -4.178540591381638e-15 0.0;;; -3.0701101696587945e-15 0.0; -4.616801062455776e-17 0.0;;; -1.0468866291263263e-16 0.0; 2.7578217105107607e-16 0.0;;;; -6.252269011448315e-5 0.0; 0.0 0.0;;; -2.04852264256754e-7 0.0; 0.0 0.0;;; -7.06662612378841e-8 0.0; -2.0419658967880125e-7 0.0;;; … ;;; -5.3641695111647346e-17 0.0; -1.182265795723175e-17 0.0;;; -4.3481251648150213e-16 0.0; -1.0232198233441105e-16 0.0;;; 9.59147187104545e-17 0.0; -1.3323357104699044e-16 0.0;;;; -0.00016674168254879578 0.0; 0.0 0.0;;; -1.965036556238965e-6 0.0; 0.0 0.0;;; 3.822622779824304e-7 0.0; -1.4564227081927322e-7 0.0;;; … ;;; -2.217532327146906e-15 0.0; -1.496353077427457e-16 0.0;;; 2.5157083538699377e-15 0.0; 3.1275180931033295e-16 0.0;;; -2.8727896827770557e-16 0.0; 4.389395710420473e-16 0.0], UnitRange{Int64}[1:1, 2:9, 10:73, 74:585, 586:4681], [586, 587, 588, 589, 590, 591, 592, 593, 594, 595  …  4672, 4673, 4674, 4675, 4676, 4677, 4678, 4679, 4680, 4681], ([4451, 4672, 8289, 14431, 28345, 34749, 35261, 36248, 41762, 44140  …  23515, 25182, 25715, 27912, 28744, 29131, 38267, 42992, 46335, 49303],), ([34221, 25573, 10506, 28227, 5964, 24088, 47163, 23447, 14686, 31641  …  37274, 31518, 11617, 33099, 36752, 13299, 22380, 44294, 11274, 40937],), ([0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; … ; 6.453930575067661e-6 0.000530235313349985 … 0.0010983597791527128 0.0007526951297042993; 1.875345041569765e-5 1.3974956481239035e-5 … 1.782131317352117e-5 7.357874501731705e-6],), [[0.057953233489537403 0.015311454120491952 … 0.9422997165209949 0.9925373472424999; 0.0325170388113698 0.005581167277868393 … 0.9756966141458929 0.963405463614484; 0.05681388716981173 0.021771321079524175 … 0.9840514906123553 0.9647137671851761]], 5, [20]), StaticArraysCore.SVector{2, Int32}[[10, 147], [10, 149], [10, 151], [10, 153], [10, 163], [10, 165], [10, 167], [10, 169], [10, 179], [10, 181]  …  [4679, 529], [4679, 536], [4679, 576], [4680, 453], [4680, 529], [4680, 536], [4681, 453], [4681, 529], [4681, 536], [4681, 576]], StaticArraysCore.SVector{2, Int32}[[586, 586], [586, 587], [586, 588], [586, 589], [586, 590], [586, 591], [586, 592], [586, 593], [586, 594], [586, 595]  …  [4681, 4672], [4681, 4673], [4681, 4674], [4681, 4675], [4681, 4676], [4681, 4677], [4681, 4678], [4681, 4679], [4681, 4680], [4681, 4681]], (DerivativesSwitch{true, false, false}(),), true)</code></pre><p>This keyword argument <code>ε_tol=PowerAbsolutePotential(1e-4)</code> requests that the expansion order be dynamically adjusted to ensure that the potential error of each interaction is less than <code>1e-4</code> at each body. Note that this does ensure a perfectly conservative error bound, since many multipole-to-local transformations will be performed to any given target cell. However, the maximum error should be within an order of magnitude of the specified tolerance, and the average error will be much lower.</p><pre><code class="language-julia hljs"># verify error
phi_fmm = system.potential[1,:]
system.potential .= 0.0
direct!(system; scalar_potential=true, gradient=false, hessian=false)
phi_direct = system.potential[1,:]
println(&quot;Max error in potential: &quot;, maximum(abs.(phi_direct .- phi_fmm)))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Max error in potential: 0.0007089112080502918</code></pre><p>It is also worth noting that the error methods used here sometimes fail for coarse tolerances. Let&#39;s see what happens when we try to use a tolerance of <code>1e-2</code>:</p><pre><code class="language-julia hljs"># run FMM with error tolerance
system.potential .= 0.0
fmm!(system; lamb_helmholtz=false, scalar_potential=true, gradient=false, hessian=false, ε_tol=PowerAbsolutePotential(1e-2))

# check error
phi_fmm = system.potential[1,:]
println(&quot;Max error in potential: &quot;, maximum(abs.(phi_direct .- phi_fmm)))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Max error in potential: 0.0008044705656481549</code></pre><p>As a rule of thumb, care should be taken if 2 digits of accuracy or less is requested. The methods employed are fairly robust for 3 or more digits of accuracy. <code>PowerAbsolutePotential</code> and <code>PowerAbsoluteGradient</code> are best when the maximum error is to be constrained, while <code>RotatedCoefficientsAbsoluteGradient</code> is better if the mean error is to be constrained.</p><h2 id="Fully-Automatic-Tuning-of-FMM-Parameters"><a class="docs-heading-anchor" href="#Fully-Automatic-Tuning-of-FMM-Parameters">Fully Automatic Tuning of FMM Parameters</a><a id="Fully-Automatic-Tuning-of-FMM-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Fully-Automatic-Tuning-of-FMM-Parameters" title="Permalink"></a></h2><p><code>FastMultipole</code> can automatically tune the FMM parameters to satisfy an error tolerance. This is done by running the <a href="../reference/#FastMultipole.tune_fmm-Tuple{Tuple, Tuple}"><code>tune_fmm</code></a> function, which returns a named tuple of the optimal parameters and a preallocated buffer to reduce memory allocations.</p><p>Say I wanted the optimal tuning parameters for the gravitational potential of a system of point masses, with a maximum error tolerance of <code>1e-4</code>. I would call the function as follows:</p><pre><code class="language-julia hljs">opt_params, cache = tune_fmm(system; ε_tol=PowerAbsolutePotential(1e-4), lamb_helmholtz=false, scalar_potential=true, gradient=false, hessian=false)
println(&quot;Optimal parameters: &quot;, opt_params)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">
#======= Begin FastMultipole.tune_fmm() =======#

multipole_acceptance = 0.3...

	Best Parameters:
		leaf_size_source:    [9]
		expansion_order:     2
		multipole_acceptance: 0.3
		cost:                5.321943169 seconds

multipole_acceptance = 0.4...

	Best Parameters:
		leaf_size_source:    [9]
		expansion_order:     2
		multipole_acceptance: 0.4
		cost:                2.659032871 seconds

multipole_acceptance = 0.5...

	Best Parameters:
		leaf_size_source:    [9]
		expansion_order:     2
		multipole_acceptance: 0.5
		cost:                1.540061832 seconds

multipole_acceptance = 0.6...

	Best Parameters:
		leaf_size_source:    [9]
		expansion_order:     3
		multipole_acceptance: 0.6
		cost:                1.005575797 seconds

multipole_acceptance = 0.7...

	Best Parameters:
		leaf_size_source:    [9]
		expansion_order:     4
		multipole_acceptance: 0.7
		cost:                0.695970555 seconds

multipole_acceptance = 0.8...

	Best Parameters:
		leaf_size_source:    [10]
		expansion_order:     5
		multipole_acceptance: 0.8
		cost:                0.516290693 seconds

Finished autotune!

Parameters:
	leaf_size_source:    [10]
	expansion_order:     5
	multipole_acceptance: 0.8
	cost:                0.516290693 seconds

#===============================================#

Optimal parameters: (leaf_size_source = [10], expansion_order = 5, multipole_acceptance = 0.8)</code></pre><p>This will return a named tuple of the optimal parameters, which can then be passed to the <code>fmm!</code> function. The <code>cache</code> is a preallocated buffer that can be used to reduce memory allocations during the FMM call.</p><pre><code class="language-julia hljs"># run FMM without default parameters
system.potential .= 0.0
@time fmm!(system; lamb_helmholtz=false, scalar_potential=true, gradient=false, hessian=false, ε_tol=PowerAbsolutePotential(1e-4))

# verify error
phi_fmm = system.potential[1,:]
println(&quot;Max error in potential without tuning: &quot;, maximum(abs.(phi_direct .- phi_fmm)))

# run FMM with optimal parameters
@time fmm!(system; lamb_helmholtz=false, scalar_potential=true, gradient=false, hessian=false, ε_tol=PowerAbsolutePotential(1e-4), cache..., opt_params...)

# verify error
println(&quot;Max error in potential: &quot;, maximum(abs.(phi_direct .- phi_fmm)))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">  2.711825 seconds (19.06 k allocations: 107.629 MiB, 0.45% gc time)
Max error in potential without tuning: 0.0007089112080502918
  0.571128 seconds (147.38 k allocations: 37.330 MiB, 1.04% gc time, 8.05% compilation time)
Max error in potential: 0.0007089112080502918</code></pre><p>Note that the <code>tune_fmm</code> function iterates over each requested <code>multipole_acceptance</code> criterion, so it is not optimal to call it before every FMM call. Instead, <code>tune_fmm</code> can be called once for a representative system primarily to choose <code>multipole_acceptance</code>. Since the optimal parameters depend on the size, distribution, and strengths of the sources and targets, it is recommended to set the keyword argument <code>tune=true</code> to iteratively update the <code>expansion_order</code> and <code>leaf_size_source</code> parameters each time <code>fmm!</code> is called. This will allow the FMM to adapt to the system as it evolves, and will ensure that the optimal parameters are used for each call.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../guided_examples/">« Guided Examples</a><a class="docs-footer-nextpage" href="../reference/">Reference »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.12.0 on <span class="colophon-date" title="Tuesday 17 June 2025 19:57">Tuesday 17 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
