<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Guided Examples · FastMultipole.jl</title><meta name="title" content="Guided Examples · FastMultipole.jl"/><meta property="og:title" content="Guided Examples · FastMultipole.jl"/><meta property="twitter:title" content="Guided Examples · FastMultipole.jl"/><meta name="description" content="Documentation for FastMultipole.jl."/><meta property="og:description" content="Documentation for FastMultipole.jl."/><meta property="twitter:description" content="Documentation for FastMultipole.jl."/><meta property="og:url" content="https://flow.byu.edu/FastMultipole/guided_examples/"/><meta property="twitter:url" content="https://flow.byu.edu/FastMultipole/guided_examples/"/><link rel="canonical" href="https://flow.byu.edu/FastMultipole/guided_examples/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">FastMultipole.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Introduction</a></li><li><a class="tocitem" href="../quickstart/">Quick Start</a></li><li class="is-active"><a class="tocitem" href>Guided Examples</a><ul class="internal"><li><a class="tocitem" href="#Gravitational-Example"><span>Gravitational Example</span></a></li><li><a class="tocitem" href="#Vortex-Filament-Example"><span>Vortex Filament Example</span></a></li></ul></li><li><a class="tocitem" href="../advanced_usage/">Advanced Usage</a></li><li><a class="tocitem" href="../reference/">Reference</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Guided Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Guided Examples</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/byuflowlab/FastMultipole" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/byuflowlab/FastMultipole/blob/main/docs/src/guided_examples.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Guided-Examples"><a class="docs-heading-anchor" href="#Guided-Examples">Guided Examples</a><a id="Guided-Examples-1"></a><a class="docs-heading-anchor-permalink" href="#Guided-Examples" title="Permalink"></a></h1><p><code>FastMultipole</code> is designed to incorporate easily into your existing Julia code with minimal effort. In particular, several interface functions must be defined. We&#39;ll walk through the process in the following guided examples.</p><h2 id="Gravitational-Example"><a class="docs-heading-anchor" href="#Gravitational-Example">Gravitational Example</a><a id="Gravitational-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Gravitational-Example" title="Permalink"></a></h2><p>In this example, we review the interface functions used by the gravitational point mass model used in <a href="../quickstart/#Quick-Start">Quick Start</a>. This code can also be found under <code>FastMultipole/test/gravitational.jl</code>.</p><p>To better understand how the <code>FastMultipole</code> interface functions, let&#39;s take a look at the data structures we&#39;ll use to define our point masses:</p><pre><code class="language-julia hljs">using FastMultipole
using FastMultipole.StaticArrays

const i_POTENTIAL = 1:1   # index of the gravitational potential
const i_GRADIENT = 5:7    # index of the gravitational acceleration
const i_HESSIAN = 8:16    # index of the hessian matrix

# a single point mass
struct Body{TF}
    position::SVector{3,TF}
    radius::TF
    strength::SVector{4,TF}
end

# container for a system of `Body`&#39;s
struct Gravitational{TF}
    bodies::Vector{Body{TF}}
    potential::Matrix{TF}
end

# constructor
function Gravitational(bodies::Matrix)
    nbodies = size(bodies)[2]
    bodies2 = [Body(SVector{3}(bodies[1:3,i]),bodies[4,i],SVector{4}(bodies[5:8,i])) for i in 1:nbodies]
    potential = zeros(52,nbodies)
    return Gravitational(bodies2,potential)
end</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Main.Gravitational</code></pre><p>In short, <code>Body</code> objects represent individual point masses, and the <code>Gravitational</code> object contains a group of them, along with a matrix of the potential, velocity, and velocity gradient at each body. The observant reader will notice that the <code>strength</code> field of <code>Body</code> is a 4-vector. The first index contains the mass of the body, used to induce a gravitational potential. The final three indices are meant to contain a vector strength, in case a vector potential is desired. For the sake of simplicy, we will assume <code>strength[2:4]</code> is zero for now. </p><h3 id="Overloading-body_to_multipole!"><a class="docs-heading-anchor" href="#Overloading-body_to_multipole!">Overloading <code>body_to_multipole!</code></a><a id="Overloading-body_to_multipole!-1"></a><a class="docs-heading-anchor-permalink" href="#Overloading-body_to_multipole!" title="Permalink"></a></h3><p>The function <code>body_to_multipole!</code> is used to generate multipole expansions for our particular system. This is done be overloading <code>FastMultipole.body_to_multipole!</code> for our data structure. Convenience functions exist within <code>FastMultipole</code> to simplify this complicated function into a one-liner:</p><pre><code class="language-julia hljs">FastMultipole.body_to_multipole!(system::Gravitational, args...) =
    FastMultipole.body_to_multipole!(Point{Source}, system, args...)</code></pre><p>The <code>::Gravitational</code> type annotation is the key that allows <code>FastMultipole</code> to dispatch on <code>::Gravitational</code> systems. <code>Point{Source}</code> is used to indicate that our bodies are points and induce a source (i.e. <span>$1/r$</span>) potential. Other convenience functions exist in <code>FastMultipole</code> for any combination of <code>Point</code>, <code>Filament</code>, or <code>Panel</code> geometries using <code>Source</code>, <code>Dipole</code>, or <code>Vortex</code> kernels, and are specified when overloading <code>body_to_multipole!</code> as <code>&lt;geometry&gt;{&lt;kernel&gt;}</code>. For example, if my model used constant vortex sheet panels, I would replace <code>Point{Source}</code> in the example above to <code>Panel{Vortex}</code>.</p><p>We use the fast recursive method of generating exact coefficients for panels as developed by [<a href="../theory/#GUMEROV2023112118">1</a>]. We have derived our own formulae for vortex filaments and panels, which are in the process of publication.</p><h3 id="Buffer-Interface-Functions"><a class="docs-heading-anchor" href="#Buffer-Interface-Functions">Buffer Interface Functions</a><a id="Buffer-Interface-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Buffer-Interface-Functions" title="Permalink"></a></h3><p><code>FastMultipole</code> allocates a buffer matrix in which to sort and store key system information. The buffer interface is created by overloading several functions for the user-defined system type. The first of these functions is <a href="../reference/#FastMultipole.source_system_to_buffer!-NTuple{4, Any}"><code>FastMultipole.source_system_to_buffer!</code></a>, which populates a matrix with the important information about each body, column-wise. Overloading for <code>::Gravitational</code> systems looks like this:</p><pre><code class="language-julia hljs">function FastMultipole.source_system_to_buffer!(buffer, i_buffer, system::Gravitational, i_body)
    buffer[1:3, i_buffer] .= system.bodies[i_body].position
    buffer[4, i_buffer] = system.bodies[i_body].radius
    buffer[5, i_buffer] = system.bodies[i_body].strength[1]
end</code></pre><p>Here, the <code>i_body</code>th body position, radius, and strength are copied to the correct positions in the <code>i_buffer</code>th column of the buffer matrix.</p><p>It is worth noting that there are ways of defining these functions that would harm performance, e.g. by allocating an array each time the velocity is requested. If you notice <code>FastMultipole</code>&#39;s performance is poor, this and the other interface functions are good places to check.</p><p>Because every system can have a unique buffer structure, we need to overload a few additional functions to tell <code>FastMultipole</code> how to allocate and access it. The first function, <code>data_per_body</code>, returns the number of rows in the buffer matrix that are used to define a single body. The second function, <code>get_position</code>, returns the position of the <code>i</code>th body in the system. The third function, <code>strength_dims</code>, returns the number of rows in the buffer matrix that are used to define the strength of a single body. Finally, we overload <code>get_n_bodies</code> to return the number of bodies in our system. For our <code>Gravitational</code> system, we define:</p><pre><code class="language-julia hljs">Base.eltype(::Gravitational{TF}) where TF = TF

function FastMultipole.data_per_body(system::Gravitational)
    return 5
end

function FastMultipole.get_position(system::Gravitational, i)
    return system.bodies[i].position
end

function FastMultipole.strength_dims(system::Gravitational)
    return 1
end

FastMultipole.get_n_bodies(system::Gravitational) = length(system.bodies)</code></pre><p>These functions provide enough information for <code>FastMultipole</code> to allocate the buffer matrix and access the data it needs.</p><p>Finally, we need to tell <code>FastMultipole</code> how to transfer the results of the FMM call back to the user-defined system. This is done by overloading the <a href="../reference/#FastMultipole.buffer_to_target_system!-NTuple{5, Any}"><code>FastMultipole.buffer_to_target_system!</code></a> function. Overloading for <code>::Gravitational</code> systems looks like this:</p><pre><code class="language-julia hljs">function FastMultipole.buffer_to_target_system!(target_system::Gravitational, i_target, ::FastMultipole.DerivativesSwitch{PS,VS,GS}, target_buffer, i_buffer) where {PS,VS,GS}
    # get values
    TF = eltype(target_buffer)
    scalar_potential = PS ? FastMultipole.get_scalar_potential(target_buffer, i_buffer) : zero(TF)
    velocity = VS ? FastMultipole.get_gradient(target_buffer, i_buffer) : zero(SVector{3,TF})
    hessian = GS ? FastMultipole.get_hessian(target_buffer, i_buffer) : zero(SMatrix{3,3,TF,9})

    # update system
    target_system.potential[i_POTENTIAL[1], i_target] = scalar_potential
    target_system.potential[i_GRADIENT, i_target] .= velocity
    for (jj,j) in enumerate(i_HESSIAN)
        target_system.potential[j, i_target] = hessian[jj]
    end
end</code></pre><p>We note that the convenience functions <code>get_velocity</code> and <code>get_hessian</code> return <code>::SVector{3}</code> and <code>::SMatrix{3,3}</code>, respectively, to reduce allocations.</p><h3 id="Overloading-direct!"><a class="docs-heading-anchor" href="#Overloading-direct!">Overloading <code>direct!</code></a><a id="Overloading-direct!-1"></a><a class="docs-heading-anchor-permalink" href="#Overloading-direct!" title="Permalink"></a></h3><p>The last required interface function is <a href="../reference/#FastMultipole.direct!-NTuple{6, Any}"><code>FastMultipole.direct!</code></a>, which evaluates the potential at a target system using a source system without multipole acceleration. This is required in an FMM call for those interactions that are too close to be approximated by expansions. It is also useful for debugging and testing the accuracy of the FMM call. Overloading for <code>::Gravitational</code> systems, we have:</p><pre><code class="language-julia hljs">function FastMultipole.direct!(target_system, target_index, ::DerivativesSwitch{PS,VS,GS}, source_system::Gravitational, source_buffer, source_index) where {PS,VS,GS}
    @inbounds for i_source in source_index
        source_x, source_y, source_z = FastMultipole.get_position(source_buffer, i_source)
        source_strength = FastMultipole.get_strength(source_buffer, source_system, i_source)[1]
        @inbounds for j_target in target_index
            target_x, target_y, target_z = FastMultipole.get_position(target_system, j_target)
            dx = target_x - source_x
            dy = target_y - source_y
            dz = target_z - source_z
            r2 = dx*dx + dy*dy + dz*dz
            if r2 &gt; 0
                r = sqrt(r2)
                if PS
                    dϕ = source_strength / r * FastMultipole.ONE_OVER_4π
                    FastMultipole.set_scalar_potential!(target_system, j_target, dϕ)
                end
                if VS
                    dF = SVector{3}(dx,dy,dz) * source_strength / (r2 * r) * FastMultipole.ONE_OVER_4π
                    FastMultipole.set_gradient!(target_system, j_target, dF)
                end
            end
        end
    end
end</code></pre><p>Note that the velocity gradient is not calculated in this function. If the velocity gradient is requested, the contribution due to <code>::Gravitational</code> systems will then be zero.</p><h3 id="Running-the-FMM"><a class="docs-heading-anchor" href="#Running-the-FMM">Running the FMM</a><a id="Running-the-FMM-1"></a><a class="docs-heading-anchor-permalink" href="#Running-the-FMM" title="Permalink"></a></h3><p>Now that we have defined the interface functions, we can run the FMM on our <code>Gravitational</code> system. The <a href="../reference/#FastMultipole.fmm!-Tuple{Tuple, Tuple}"><code>fmm!</code></a> function is used to perform the FMM call. For example,</p><pre><code class="language-julia hljs">using Random

# create system
function generate_gravitational(seed, n_bodies; radius_factor=0.1, strength_scale=1/n_bodies, bodies_fun=(x)-&gt;x)
    Random.seed!(seed)
    bodies = rand(8,n_bodies)
    # bodies = rand(distribution,8,n_bodies)
    bodies[4,:] ./= (n_bodies^(1/3)*2)
    bodies[4,:] .*= radius_factor
    bodies[5,:] .*= strength_scale

    bodies_fun(bodies)

    system = Gravitational(bodies)
end

n_bodies, rand_seed = 1000, 123
system = generate_gravitational(rand_seed, n_bodies)

# run FMM
fmm!(system; lamb_helmholtz=false, scalar_potential=false, gradient=true, hessian=true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((leaf_size_source = [20], expansion_order = 5, multipole_acceptance = 0.4), (target_buffers = ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), target_small_buffers = [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], source_buffers = ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.000563448390660597 0.0028260713299043416 … 0.0001521155463330443 0.004141438543486005; 0.000978179920475552 0.00018729398469243441 … 0.0005066043638526878 0.0005686419495976187],), source_small_buffers = [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5001998136682482, 0.49993551265021, 0.4998270977982316], [0.5001998136682482, 0.49993551265021, 0.4998270977982316], 0.8555020311253966, 0.8555020311253966, [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[1:129], 8, 10:17, 1, -1, [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], 0.39434130204154216, 0.39434130204154216, [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[130:256], 8, 18:25, 1, -1, [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], 0.41774644436635594, 0.41774644436635594, [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[257:381], 8, 26:33, 1, -1, [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], 0.4090146201931587, 0.4090146201931587, [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[382:507], 8, 34:41, 1, -1, [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], 0.4151792260522991, 0.4151792260522991, [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[508:630], 8, 42:49, 1, -1, [0.252410143525497, 0.24949442623750556, 0.749791070728338], [0.252410143525497, 0.24949442623750556, 0.749791070728338], 0.39947385610723785, 0.39947385610723785, [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[631:757], 8, 50:57, 1, -1, [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], 0.4085722695730153, 0.4085722695730153, [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[758:886], 8, 58:65, 1, -1, [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], 0.3944024337208189, 0.3944024337208189, [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], 0.0), Branch{Float64, 1}([114], UnitRange{Int64}[887:1000], 8, 66:73, 1, -1, [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], 0.4194297904134623, 0.4194297904134623, [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[1:20], 0, 74:73, 2, 1, [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], 0.1625689130548431, 0.1625689130548431, [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], 0.0)  …  Branch{Float64, 1}([14], UnitRange{Int64}[856:869], 0, 74:73, 8, 55, [0.10644698640761496, 0.895465315438814, 0.8606218741473264], [0.10644698640761496, 0.895465315438814, 0.8606218741473264], 0.1393423281198453, 0.1393423281198453, [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[870:886], 0, 74:73, 8, 56, [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], 0.18295563489934602, 0.18295563489934602, [0.11756885838692133, 0.12131175031325891, 0.102638668058885], [0.11756885838692133, 0.12131175031325891, 0.102638668058885], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[887:900], 0, 74:73, 9, 57, [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], 0.16380301942388953, 0.16380301942388953, [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[901:910], 0, 74:73, 9, 58, [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], 0.16847619188040783, 0.16847619188040783, [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[911:926], 0, 74:73, 9, 59, [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], 0.17986540424568168, 0.17986540424568168, [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[927:938], 0, 74:73, 9, 60, [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], 0.13133480412647142, 0.13133480412647142, [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[939:952], 0, 74:73, 9, 61, [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], 0.16635596863705976, 0.16635596863705976, [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[953:970], 0, 74:73, 9, 62, [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], 0.19438037599097202, 0.19438037599097202, [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[971:982], 0, 74:73, 9, 63, [0.6321201124574805, 0.8874986817824024, 0.869152068698644], [0.6321201124574805, 0.8874986817824024, 0.869152068698644], 0.15328030111711102, 0.15328030111711102, [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], 0.1567122096012929, 0.1567122096012929, [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], 0.0)], [0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([113, 136, 154, 156, 197, 247, 253, 256, 355, 377  …  401, 423, 528, 571, 580, 588, 648, 922, 955, 998],), ([678, 508, 210, 569, 109, 477, 939, 478, 292, 631  …  869, 20, 308, 369, 725, 67, 886, 1000, 677, 171],), ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], 5, [20]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5012594200939104, 0.5002980152903919, 0.4994562100145977], [0.5001998136682482, 0.49993551265021, 0.4998270977982316], 0.8569138924900458, 0.8555020311253966, [0.503241256041782, 0.5037131496409214, 0.5030560691211726], [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[1:129], 8, 10:17, 1, -1, [0.24848554604632245, 0.2514270116041976, 0.24865499874954983], [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], 0.3959102931577929, 0.39434130204154216, [0.25046738199419405, 0.24429784652781905, 0.24541734516610964], [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[130:256], 8, 18:25, 1, -1, [0.7541410793275398, 0.2471647362383796, 0.24945068482443805], [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], 0.4204183562402636, 0.41774644436635594, [0.2473302628813432, 0.25057987058890907, 0.25305054393101295], [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[257:381], 8, 26:33, 1, -1, [0.243081005431966, 0.7456468259116596, 0.2524798551333135], [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], 0.4116981209328202, 0.4090146201931587, [0.24494941342157925, 0.24200726555982177, 0.2463207419896702], [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[382:507], 8, 34:41, 1, -1, [0.7503316898327316, 0.7632028284106641, 0.25054969341432287], [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], 0.417341791985878, 0.4151792260522991, [0.2541689863029609, 0.23965309432578918, 0.2530609196919117], [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[508:630], 8, 42:49, 1, -1, [0.25310098213175536, 0.2498595483292485, 0.7490936213208235], [0.252410143525497, 0.24949442623750556, 0.749791070728338], 0.40391988782827914, 0.39947385610723785, [0.24849363401160884, 0.25296192529561334, 0.25319858117028526], [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[631:757], 8, 50:57, 1, -1, [0.7549758448424829, 0.25233809544861346, 0.75068528672779], [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], 0.41048395651215475, 0.4085722695730153, [0.2485559986477418, 0.2500525940504427, 0.2482979522013813], [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[758:886], 8, 58:65, 1, -1, [0.24830924861575526, 0.7506473587526798, 0.7483321424705329], [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], 0.3963457164221391, 0.3944024337208189, [0.2464576385709995, 0.2531385889572837, 0.24861993269632998], [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], 0.0), Branch{Float64, 1}([114], UnitRange{Int64}[887:1000], 8, 66:73, 1, -1, [0.7433269522233934, 0.7529076254047766, 0.7518801312273082], [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], 0.42242691866632287, 0.4194297904134623, [0.24582438230209636, 0.25110353952653663, 0.2506321479084621], [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[1:20], 0, 74:73, 2, 1, [0.1283371663280624, 0.13186074590417968, 0.12093560534862899], [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], 0.16560950569474153, 0.1625689130548431, [0.11581786590115842, 0.11539769821088727, 0.11769795176518877], [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], 0.0)  …  Branch{Float64, 1}([14], UnitRange{Int64}[856:869], 0, 74:73, 8, 55, [0.10660626645853431, 0.8970409037293949, 0.8612842641932827], [0.10644698640761496, 0.895465315438814, 0.8606218741473264], 0.14130592700531538, 0.1393423281198453, [0.09839014027927316, 0.10674504398056861, 0.09983879925038963], [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[870:886], 0, 74:73, 8, 56, [0.3735411225743902, 0.8730736549887037, 0.8539208027139634], [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], 0.18546289821117, 0.18295563489934602, [0.12122576461236456, 0.12362029150573839, 0.10594931156821619], [0.11756885838692133, 0.12131175031325891, 0.102638668058885], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[887:900], 0, 74:73, 9, 57, [0.62353666402261, 0.6113892640447769, 0.6181273576970197], [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], 0.16523639692618647, 0.16380301942388953, [0.12243085149580568, 0.10471195363432473, 0.11136586813780869], [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[901:910], 0, 74:73, 9, 58, [0.8439142229117428, 0.628244780934836, 0.6386203779487198], [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], 0.17300047332904894, 0.16847619188040783, [0.07867506712930583, 0.12165408215921591, 0.10756812849667341], [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[911:926], 0, 74:73, 9, 59, [0.6026131990860174, 0.8663161146913152, 0.6246992191078098], [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], 0.18366943689197512, 0.17986540424568168, [0.10511062916472047, 0.11171987082313573, 0.12345123578896355], [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[927:938], 0, 74:73, 9, 60, [0.8238032840345576, 0.8618282799017296, 0.6555695523425167], [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], 0.1362384160875249, 0.13133480412647142, [0.06615576384876687, 0.10360542931919137, 0.08465743005623183], [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[939:952], 0, 74:73, 9, 61, [0.6214179005720923, 0.6246406006715812, 0.8761740079121982], [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], 0.1685271705885858, 0.16635596863705976, [0.11324384231039919, 0.12283651479334134, 0.10771000135475517], [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[953:970], 0, 74:73, 9, 62, [0.8678652865718393, 0.6152972424695556, 0.8813683272439332], [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], 0.19612268290944765, 0.19438037599097202, [0.1212860479536505, 0.11267661477180657, 0.12114395189183713], [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[971:982], 0, 74:73, 9, 63, [0.6304976332368335, 0.8893863771942812, 0.8706923271860381], [0.6321201124574805, 0.8874986817824024, 0.869152068698644], 0.15665191805412432, 0.15328030111711102, [0.11040737028223113, 0.11462478773703211, 0.10333920431153232], [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8769623245840994, 0.872119321345453, 0.861521601686185], [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], 0.16209361369326653, 0.1567122096012929, [0.10813529689291035, 0.12507178399903784, 0.1107845290338818], [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], 0.0)], [-0.5037462139573649 0.0; 0.0 0.0;;; 0.001743184738536149 0.0; 0.0 0.0;;; -0.002555548564454704 0.0; -0.0013895713218064487 0.0;;; … ;;; -5.90070253177838e-7 0.0; -3.0423899624632373e-7 0.0;;; 2.6427929920170685e-7 0.0; 5.5857707603999626e-8 0.0;;; 6.225996888283763e-8 0.0; 7.277603112120663e-8 0.0;;;; -0.06741462936326656 0.0; 0.0 0.0;;; 0.0014932509207360011 0.0; 0.0 0.0;;; -0.00013542264368418907 0.0; -8.167372077861902e-5 0.0;;; … ;;; -3.3090315254238773e-10 0.0; -6.1054099890296725e-9 0.0;;; -4.384061870814601e-9 0.0; -6.394869711459733e-11 0.0;;; -7.202952919546825e-10 0.0; 1.9098745578236843e-10 0.0;;;; -0.06413338340065665 0.0; 0.0 0.0;;; 0.000933554943455932 0.0; 0.0 0.0;;; 0.00024125879073434047 0.0; 0.0003406397365188971 0.0;;; … ;;; 5.574013386921131e-9 0.0; 1.0815099826799401e-8 0.0;;; -2.3114333115781464e-8 0.0; -2.3294267236615296e-10 0.0;;; -1.1574550679526453e-9 0.0; -2.1239097750352626e-9 0.0;;;; … ;;;; -0.011820150854923139 0.0; 0.0 0.0;;; 6.96902745142642e-5 0.0; 0.0 0.0;;; -2.9629464332040005e-5 0.0; 0.00014635530644973438 0.0;;; … ;;; -2.2005297787204382e-10 0.0; -2.0978985287508486e-10 0.0;;; -1.6958155621638692e-10 0.0; -9.592582028674472e-11 0.0;;; 6.677926064851717e-13 0.0; 7.456648764477853e-12 0.0;;;; -0.005166195405825436 0.0; 0.0 0.0;;; 3.2402571687643404e-5 0.0; 0.0 0.0;;; -0.00011910329550968744 0.0; 5.758191356049709e-5 0.0;;; … ;;; 1.4081958961073293e-10 0.0; 8.246239266766892e-11 0.0;;; -2.77171762428628e-11 0.0; 4.21574242686769e-11 0.0;;; 1.479823005204894e-11 0.0; -1.18786804398805e-12 0.0;;;; -0.008581988791021485 0.0; 0.0 0.0;;; -0.00020176428880487298 0.0; 0.0 0.0;;; -0.00013634378162834674 0.0; -7.377642771669852e-5 0.0;;; … ;;; -5.016977232407524e-11 0.0; -4.985874858819863e-11 0.0;;; 2.2791423029954488e-11 0.0; 2.3145265315887942e-11 0.0;;; 2.0839073725360884e-11 0.0; 9.961078310363642e-12 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([113, 136, 154, 156, 197, 247, 253, 256, 355, 377  …  401, 423, 528, 571, 580, 588, 648, 922, 955, 998],), ([678, 508, 210, 569, 109, 477, 939, 478, 292, 631  …  869, 20, 308, 369, 725, 67, 886, 1000, 677, 171],), ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.000563448390660597 0.0028260713299043416 … 0.0001521155463330443 0.004141438543486005; 0.000978179920475552 0.00018729398469243441 … 0.0005066043638526878 0.0005686419495976187],), [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], 5, [20]), StaticArraysCore.SVector{2, Int32}[], StaticArraysCore.SVector{2, Int32}[[10, 10], [10, 11], [10, 12], [10, 13], [10, 14], [10, 15], [10, 16], [10, 17], [10, 18], [10, 19]  …  [73, 64], [73, 65], [73, 66], [73, 67], [73, 68], [73, 69], [73, 70], [73, 71], [73, 72], [73, 73]], (DerivativesSwitch{false, true, true}(),), true)</code></pre><p>We have supplied <code>lamb_helmholtz=false</code> to the FMM call because the gravitational potential is a scalar potential and does not require the Lamb-Helmholtz decomposition of a vector field. This is not strictly necessary, since the predicted potential would be identical regardless. However, it does provide a slight performance benefit by omitting the Lamb-Helmholtz operators. The <code>scalar_potential</code> and <code>gradient</code> arguments are set to <code>false</code> and <code>true</code>, respectively, to indicate that we want to compute the vector field (i.e. the gravitational field lines that translate to force and their gradient) but not the scalar potential.</p><h3 id="Preallocating-the-Buffers"><a class="docs-heading-anchor" href="#Preallocating-the-Buffers">Preallocating the Buffers</a><a id="Preallocating-the-Buffers-1"></a><a class="docs-heading-anchor-permalink" href="#Preallocating-the-Buffers" title="Permalink"></a></h3><p>The <code>fmm!</code> function incurs a small overhead for allocating the buffer matrices. If our system is large and the FMM will be called more than once, we can preallocate the buffers to avoid this overhead. This is done by returning the buffer cache the first time <code>fmm!</code> is called, and then splatting it as an optional argument to <code>fmm!</code> in subsequent calls as follows:</p><pre><code class="language-julia hljs"># allocate buffer cache
println(&quot;#--- allocating benchmark ---#\n&quot;)
@time _, cache, _ = fmm!(system; lamb_helmholtz=false, scalar_potential=false, gradient=true, hessian=true)

# run FMM with preallocated buffers
println(&quot;\n#--- preallocated benchmark ---#\n&quot;)
@time fmm!(system; lamb_helmholtz=false, scalar_potential=false, gradient=true, hessian=true, cache...)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((leaf_size_source = [20], expansion_order = 5, multipole_acceptance = 0.4), (target_buffers = ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), target_small_buffers = [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], source_buffers = ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.000563448390660597 0.0028260713299043416 … 0.0001521155463330443 0.004141438543486005; 0.000978179920475552 0.00018729398469243441 … 0.0005066043638526878 0.0005686419495976187],), source_small_buffers = [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5001998136682482, 0.49993551265021, 0.4998270977982316], [0.5001998136682482, 0.49993551265021, 0.4998270977982316], 0.8555020311253966, 0.8555020311253966, [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[1:129], 8, 10:17, 1, -1, [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], 0.39434130204154216, 0.39434130204154216, [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[130:256], 8, 18:25, 1, -1, [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], 0.41774644436635594, 0.41774644436635594, [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[257:381], 8, 26:33, 1, -1, [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], 0.4090146201931587, 0.4090146201931587, [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[382:507], 8, 34:41, 1, -1, [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], 0.4151792260522991, 0.4151792260522991, [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[508:630], 8, 42:49, 1, -1, [0.252410143525497, 0.24949442623750556, 0.749791070728338], [0.252410143525497, 0.24949442623750556, 0.749791070728338], 0.39947385610723785, 0.39947385610723785, [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[631:757], 8, 50:57, 1, -1, [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], 0.4085722695730153, 0.4085722695730153, [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[758:886], 8, 58:65, 1, -1, [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], 0.3944024337208189, 0.3944024337208189, [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], 0.0), Branch{Float64, 1}([114], UnitRange{Int64}[887:1000], 8, 66:73, 1, -1, [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], 0.4194297904134623, 0.4194297904134623, [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[1:20], 0, 74:73, 2, 1, [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], 0.1625689130548431, 0.1625689130548431, [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], 0.0)  …  Branch{Float64, 1}([14], UnitRange{Int64}[856:869], 0, 74:73, 8, 55, [0.10644698640761496, 0.895465315438814, 0.8606218741473264], [0.10644698640761496, 0.895465315438814, 0.8606218741473264], 0.1393423281198453, 0.1393423281198453, [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[870:886], 0, 74:73, 8, 56, [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], 0.18295563489934602, 0.18295563489934602, [0.11756885838692133, 0.12131175031325891, 0.102638668058885], [0.11756885838692133, 0.12131175031325891, 0.102638668058885], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[887:900], 0, 74:73, 9, 57, [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], 0.16380301942388953, 0.16380301942388953, [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[901:910], 0, 74:73, 9, 58, [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], 0.16847619188040783, 0.16847619188040783, [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[911:926], 0, 74:73, 9, 59, [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], 0.17986540424568168, 0.17986540424568168, [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[927:938], 0, 74:73, 9, 60, [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], 0.13133480412647142, 0.13133480412647142, [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[939:952], 0, 74:73, 9, 61, [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], 0.16635596863705976, 0.16635596863705976, [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[953:970], 0, 74:73, 9, 62, [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], 0.19438037599097202, 0.19438037599097202, [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[971:982], 0, 74:73, 9, 63, [0.6321201124574805, 0.8874986817824024, 0.869152068698644], [0.6321201124574805, 0.8874986817824024, 0.869152068698644], 0.15328030111711102, 0.15328030111711102, [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], 0.1567122096012929, 0.1567122096012929, [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], 0.0)], [0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([113, 136, 154, 156, 197, 247, 253, 256, 355, 377  …  401, 423, 528, 571, 580, 588, 648, 922, 955, 998],), ([678, 508, 210, 569, 109, 477, 939, 478, 292, 631  …  869, 20, 308, 369, 725, 67, 886, 1000, 677, 171],), ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], 5, [20]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5012594200939104, 0.5002980152903919, 0.4994562100145977], [0.5001998136682482, 0.49993551265021, 0.4998270977982316], 0.8569138924900458, 0.8555020311253966, [0.503241256041782, 0.5037131496409214, 0.5030560691211726], [0.49960074530135734, 0.4993860580033119, 0.4995678288594521], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[1:129], 8, 10:17, 1, -1, [0.24848554604632245, 0.2514270116041976, 0.24865499874954983], [0.24796734131220932, 0.2521267232838717, 0.2491977220079547], 0.3959102931577929, 0.39434130204154216, [0.25046738199419405, 0.24429784652781905, 0.24541734516610964], [0.2473682729453186, 0.24183498958234012, 0.24119740373990056], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[130:256], 8, 18:25, 1, -1, [0.7541410793275398, 0.2471647362383796, 0.24945068482443805], [0.7548475340979026, 0.2483947890313949, 0.24957283030507066], 0.4204183562402636, 0.41774644436635594, [0.2473302628813432, 0.25057987058890907, 0.25305054393101295], [0.24309748971274092, 0.24752020901206984, 0.2491899652761113], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[257:381], 8, 26:33, 1, -1, [0.243081005431966, 0.7456468259116596, 0.2524798551333135], [0.2436841322214583, 0.7458834912687611, 0.25336123010329603], 0.4116981209328202, 0.4090146201931587, [0.24494941342157925, 0.24200726555982177, 0.2463207419896702], [0.24246956401817127, 0.2394109926465039, 0.2442187308568673], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[382:507], 8, 34:41, 1, -1, [0.7503316898327316, 0.7632028284106641, 0.25054969341432287], [0.7503055851318262, 0.7622820191325024, 0.24981592547870107], 0.417341791985878, 0.4151792260522991, [0.2541689863029609, 0.23965309432578918, 0.2530609196919117], [0.2493527538179663, 0.23573156641805093, 0.2495566565399216], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[508:630], 8, 42:49, 1, -1, [0.25310098213175536, 0.2498595483292485, 0.7490936213208235], [0.252410143525497, 0.24949442623750556, 0.749791070728338], 0.40391988782827914, 0.39947385610723785, [0.24849363401160884, 0.25296192529561334, 0.25319858117028526], [0.24572199069952522, 0.2489449715906074, 0.24960385592934575], 0.0), Branch{Float64, 1}([127], UnitRange{Int64}[631:757], 8, 50:57, 1, -1, [0.7549758448424829, 0.25233809544861346, 0.75068528672779], [0.7538239695852369, 0.25034782151979645, 0.7508812111692619], 0.41048395651215475, 0.4085722695730153, [0.2485559986477418, 0.2500525940504427, 0.2482979522013813], [0.24597658938436862, 0.24719553795363186, 0.24507364770747875], 0.0), Branch{Float64, 1}([129], UnitRange{Int64}[758:886], 8, 58:65, 1, -1, [0.24830924861575526, 0.7506473587526798, 0.7483321424705329], [0.24784650129432034, 0.7498363127065051, 0.7502853050924407], 0.3963457164221391, 0.3944024337208189, [0.2464576385709995, 0.2531385889572837, 0.24861993269632998], [0.24261058876894553, 0.24948525794701681, 0.24630250324190062], 0.0), Branch{Float64, 1}([114], UnitRange{Int64}[887:1000], 8, 66:73, 1, -1, [0.7433269522233934, 0.7529076254047766, 0.7518801312273082], [0.7435751999750329, 0.7512179250482944, 0.7517125402641975], 0.42242691866632287, 0.4194297904134623, [0.24582438230209636, 0.25110353952653663, 0.2506321479084621], [0.24203791907243488, 0.24802733716452074, 0.24653588909072421], 0.0), Branch{Float64, 1}([20], UnitRange{Int64}[1:20], 0, 74:73, 2, 1, [0.1283371663280624, 0.13186074590417968, 0.12093560534862899], [0.13046730426850534, 0.13317092197218927, 0.12190390202598378], 0.16560950569474153, 0.1625689130548431, [0.11581786590115842, 0.11539769821088727, 0.11769795176518877], [0.11364563337191297, 0.1125143261658873, 0.11390358375792964], 0.0)  …  Branch{Float64, 1}([14], UnitRange{Int64}[856:869], 0, 74:73, 8, 55, [0.10660626645853431, 0.8970409037293949, 0.8612842641932827], [0.10644698640761496, 0.895465315438814, 0.8606218741473264], 0.14130592700531538, 0.1393423281198453, [0.09839014027927316, 0.10674504398056861, 0.09983879925038963], [0.09697449469498665, 0.10385625521470787, 0.09737550976161846], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[870:886], 0, 74:73, 8, 56, [0.3735411225743902, 0.8730736549887037, 0.8539208027139634], [0.37288823167634455, 0.8721844377681688, 0.8523387491378018], 0.18546289821117, 0.18295563489934602, [0.12122576461236456, 0.12362029150573839, 0.10594931156821619], [0.11756885838692133, 0.12131175031325891, 0.102638668058885], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[887:900], 0, 74:73, 9, 57, [0.62353666402261, 0.6113892640447769, 0.6181273576970197], [0.6233800626088727, 0.6113921550156258, 0.6174219681895645], 0.16523639692618647, 0.16380301942388953, [0.12243085149580568, 0.10471195363432473, 0.11136586813780869], [0.11820994873593982, 0.10251670445278771, 0.10974530566180674], 0.0), Branch{Float64, 1}([10], UnitRange{Int64}[901:910], 0, 74:73, 9, 58, [0.8439142229117428, 0.628244780934836, 0.6386203779487198], [0.8444687155842695, 0.6288343417650921, 0.6391974816670292], 0.17300047332904894, 0.16847619188040783, [0.07867506712930583, 0.12165408215921591, 0.10756812849667341], [0.0743785420278934, 0.11739262521553273, 0.10514148621941954], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[911:926], 0, 74:73, 9, 59, [0.6026131990860174, 0.8663161146913152, 0.6246992191078098], [0.6024256659845317, 0.8666994834495856, 0.6254127940715757], 0.18366943689197512, 0.17986540424568168, [0.10511062916472047, 0.11171987082313573, 0.12345123578896355], [0.10088838508193387, 0.1098543522994303, 0.12023614289810225], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[927:938], 0, 74:73, 9, 60, [0.8238032840345576, 0.8618282799017296, 0.6555695523425167], [0.8232005220608829, 0.8621137840222144, 0.6555879385032056], 0.1362384160875249, 0.13133480412647142, [0.06615576384876687, 0.10360542931919137, 0.08465743005623183], [0.06268549022834213, 0.10156801469337795, 0.08016021073372515], 0.0), Branch{Float64, 1}([14], UnitRange{Int64}[939:952], 0, 74:73, 9, 61, [0.6214179005720923, 0.6246406006715812, 0.8761740079121982], [0.6200087560892111, 0.6252235217118007, 0.8748917753069787], 0.1685271705885858, 0.16635596863705976, [0.11324384231039919, 0.12283651479334134, 0.10771000135475517], [0.10996781829248414, 0.11865193854951128, 0.10595845591811826], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[953:970], 0, 74:73, 9, 62, [0.8678652865718393, 0.6152972424695556, 0.8813683272439332], [0.8684659353060091, 0.6148429922648099, 0.8799756326512669], 0.19612268290944765, 0.19438037599097202, [0.1212860479536505, 0.11267661477180657, 0.12114395189183713], [0.1171471837414586, 0.11165240438103619, 0.11827279670365487], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[971:982], 0, 74:73, 9, 63, [0.6304976332368335, 0.8893863771942812, 0.8706923271860381], [0.6321201124574805, 0.8874986817824024, 0.869152068698644], 0.15665191805412432, 0.15328030111711102, [0.11040737028223113, 0.11462478773703211, 0.10333920431153232], [0.1079086750543935, 0.11174658043041275, 0.10101475696098527], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8769623245840994, 0.872119321345453, 0.861521601686185], [0.8751774935321328, 0.8716412223081114, 0.8597475998338218], 0.16209361369326653, 0.1567122096012929, [0.10813529689291035, 0.12507178399903784, 0.1107845290338818], [0.10519216895658356, 0.12115996846306132, 0.10885841163518561], 0.0)], [-0.5037462139573649 0.0; 0.0 0.0;;; 0.001743184738536149 0.0; 0.0 0.0;;; -0.002555548564454704 0.0; -0.0013895713218064487 0.0;;; … ;;; -5.90070253177838e-7 0.0; -3.0423899624632373e-7 0.0;;; 2.6427929920170685e-7 0.0; 5.5857707603999626e-8 0.0;;; 6.225996888283763e-8 0.0; 7.277603112120663e-8 0.0;;;; -0.06741462936326656 0.0; 0.0 0.0;;; 0.0014932509207360011 0.0; 0.0 0.0;;; -0.00013542264368418907 0.0; -8.167372077861902e-5 0.0;;; … ;;; -3.3090315254238773e-10 0.0; -6.1054099890296725e-9 0.0;;; -4.384061870814601e-9 0.0; -6.394869711459733e-11 0.0;;; -7.202952919546825e-10 0.0; 1.9098745578236843e-10 0.0;;;; -0.06413338340065665 0.0; 0.0 0.0;;; 0.000933554943455932 0.0; 0.0 0.0;;; 0.00024125879073434047 0.0; 0.0003406397365188971 0.0;;; … ;;; 5.574013386921131e-9 0.0; 1.0815099826799401e-8 0.0;;; -2.3114333115781464e-8 0.0; -2.3294267236615296e-10 0.0;;; -1.1574550679526453e-9 0.0; -2.1239097750352626e-9 0.0;;;; … ;;;; -0.011820150854923139 0.0; 0.0 0.0;;; 6.96902745142642e-5 0.0; 0.0 0.0;;; -2.9629464332040005e-5 0.0; 0.00014635530644973438 0.0;;; … ;;; -2.2005297787204382e-10 0.0; -2.0978985287508486e-10 0.0;;; -1.6958155621638692e-10 0.0; -9.592582028674472e-11 0.0;;; 6.677926064851717e-13 0.0; 7.456648764477853e-12 0.0;;;; -0.005166195405825436 0.0; 0.0 0.0;;; 3.2402571687643404e-5 0.0; 0.0 0.0;;; -0.00011910329550968744 0.0; 5.758191356049709e-5 0.0;;; … ;;; 1.4081958961073293e-10 0.0; 8.246239266766892e-11 0.0;;; -2.77171762428628e-11 0.0; 4.21574242686769e-11 0.0;;; 1.479823005204894e-11 0.0; -1.18786804398805e-12 0.0;;;; -0.008581988791021485 0.0; 0.0 0.0;;; -0.00020176428880487298 0.0; 0.0 0.0;;; -0.00013634378162834674 0.0; -7.377642771669852e-5 0.0;;; … ;;; -5.016977232407524e-11 0.0; -4.985874858819863e-11 0.0;;; 2.2791423029954488e-11 0.0; 2.3145265315887942e-11 0.0;;; 2.0839073725360884e-11 0.0; 9.961078310363642e-12 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([113, 136, 154, 156, 197, 247, 253, 256, 355, 377  …  401, 423, 528, 571, 580, 588, 648, 922, 955, 998],), ([678, 508, 210, 569, 109, 477, 939, 478, 292, 631  …  869, 20, 308, 369, 725, 67, 886, 1000, 677, 171],), ([0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; … ; 0.000563448390660597 0.0028260713299043416 … 0.0001521155463330443 0.004141438543486005; 0.000978179920475552 0.00018729398469243441 … 0.0005066043638526878 0.0005686419495976187],), [[0.2180753868061016 0.08620267767242829 … 0.802622651570636 0.7802496356695992; 0.2294349618891346 0.19046202028302095 … 0.9294809522702712 0.8689902046527316; 0.1602284893383219 0.23580748578391342 … 0.7508891881986363 0.883424170793133]], 5, [20]), StaticArraysCore.SVector{2, Int32}[], StaticArraysCore.SVector{2, Int32}[[10, 10], [10, 11], [10, 12], [10, 13], [10, 14], [10, 15], [10, 16], [10, 17], [10, 18], [10, 19]  …  [73, 64], [73, 65], [73, 66], [73, 67], [73, 68], [73, 69], [73, 70], [73, 71], [73, 72], [73, 73]], (DerivativesSwitch{false, true, true}(),), true)</code></pre><p>Note that the second call to <code>fmm!</code> allocates less memory.</p><h3 id="Tuning-Parameters"><a class="docs-heading-anchor" href="#Tuning-Parameters">Tuning Parameters</a><a id="Tuning-Parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Tuning-Parameters" title="Permalink"></a></h3><p>The FMM can be tuned for accuracy and performance by adjusting the following parameters: <code>multipole_acceptance</code>, <code>leaf_size</code>, and <code>expansion_order</code>. These parameters are passed to the <code>fmm!</code> function as keyword arguments. Let&#39;s take a look at how each affects the FMM:</p><pre><code class="language-julia hljs"># create system
n_bodies, rand_seed = 1000, 123
system = generate_gravitational(rand_seed, n_bodies)

# compute potential directly
direct!(system; gradient=true)
gradient_direct = system.potential[5:7,:]

# try varying `expansion_order`
println(&quot;#--- varying expansion order ---#\n&quot;)
println(&quot;\texpansion_order = 3&quot;)
fmm!(system; expansion_order=1, multipole_acceptance=0.5, leaf_size=30, gradient=true)
system.potential .= 0.0
@time fmm!(system; expansion_order=3, multipole_acceptance=0.5, leaf_size=30, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))

println(&quot;\n\texpansion_order = 8&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=5, multipole_acceptance=0.5, leaf_size=30, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))

println(&quot;\n\texpansion_order = 12&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=10, multipole_acceptance=0.5, leaf_size=30, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))

# try varying `multipole_acceptance`
println(&quot;\n#--- varying multipole acceptance ---#\n&quot;)
println(&quot;\n\tmultipole_acceptance = 0.2&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=4, multipole_acceptance=0.4, leaf_size=30, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))
println(&quot;\n\tmultipole_acceptance = 0.4&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=4, multipole_acceptance=0.4, leaf_size=30, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))
println(&quot;\n\tmultipole_acceptance = 0.8&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=4, multipole_acceptance=0.8, leaf_size=30, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))

# try varying `leaf_size`
println(&quot;\n#--- varying leaf size ---#\n&quot;)
println(&quot;\n\tleaf_size = 1&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=4, multipole_acceptance=0.5, leaf_size=10, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))
println(&quot;\n\tleaf_size = 10&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=4, multipole_acceptance=0.5, leaf_size=10, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))
println(&quot;\n\tleaf_size = 80&quot;)
system.potential .= 0.0
@time fmm!(system; expansion_order=4, multipole_acceptance=0.5, leaf_size=80, gradient=true)
println(&quot;\t\tmax error = &quot;, maximum(abs.(system.potential[5:7,:] .- gradient_direct)))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">#--- varying expansion order ---#

	expansion_order = 3
  0.006880 seconds (544 allocations: 582.969 KiB)
		max error = 1.3322676295501878e-15

	expansion_order = 8
  0.007431 seconds (544 allocations: 638.953 KiB)
		max error = 1.3322676295501878e-15

	expansion_order = 12
  0.010406 seconds (557 allocations: 869.336 KiB)
		max error = 1.3322676295501878e-15

#--- varying multipole acceptance ---#


	multipole_acceptance = 0.2
  0.007073 seconds (544 allocations: 608.547 KiB)
		max error = 1.3322676295501878e-15

	multipole_acceptance = 0.4
  0.007098 seconds (544 allocations: 608.547 KiB)
		max error = 1.3322676295501878e-15

	multipole_acceptance = 0.8
  0.005557 seconds (547 allocations: 525.445 KiB)
		max error = 0.0009867058556632183

#--- varying leaf size ---#


	leaf_size = 1
  0.007109 seconds (544 allocations: 608.547 KiB)
		max error = 1.3322676295501878e-15

	leaf_size = 10
  0.007081 seconds (544 allocations: 608.547 KiB)
		max error = 1.3322676295501878e-15

	leaf_size = 80
  0.006583 seconds (266 allocations: 289.703 KiB)
		max error = 1.2212453270876722e-15</code></pre><p>This example demonstrates some trends of how each parameter affects the  The <code>expansion_order</code> parameter is always positively correlated to accuracy but negatively correlated to cost. The parameters <code>multipole_acceptance</code> and <code>leaf_size</code> are still correlated, but less predictably so. This motivates automated tuning of the parameters. We&#39;ll explore that more in the next example.</p><h2 id="Vortex-Filament-Example"><a class="docs-heading-anchor" href="#Vortex-Filament-Example">Vortex Filament Example</a><a id="Vortex-Filament-Example-1"></a><a class="docs-heading-anchor-permalink" href="#Vortex-Filament-Example" title="Permalink"></a></h2><p>In this example, we review the interface functions used by the vortex filament model found in <code>FastMultipole/test/vortex_filament.jl</code>. First, let&#39;s take a look at the data structure:</p><pre><code class="language-julia hljs">struct VortexFilaments{TF}
    x::Matrix{SVector{3,TF}}
    strength::Vector{SVector{3,TF}}
    core_size::Vector{TF}
    ε_tol::Vector{TF}
    potential::Vector{TF}
    force::Vector{SVector{3,TF}}
    gradient::Vector{SMatrix{3,3,TF,9}}
end</code></pre><p>Note that <code>x</code> is a 2-row matrix, where the first row contains the start point of the filament and the second row contains the end point. The <code>strength</code> field contains the strength of the vortex filament, which is a vector quantity. The <code>core_size</code> field contains the regularization radius for each filament. The <code>potential</code>, <code>force</code>, and <code>gradient</code> fields are used to store the results of the FMM call.</p><h3 id="Overloading-body_to_multipole!-2"><a class="docs-heading-anchor" href="#Overloading-body_to_multipole!-2">Overloading <code>body_to_multipole!</code></a><a class="docs-heading-anchor-permalink" href="#Overloading-body_to_multipole!-2" title="Permalink"></a></h3><p>Just like we did for the gravitational example, we need to overload <code>FastMultipole.body_to_multipole!</code> for our vortex filament system. The recommended way to do this is:</p><pre><code class="language-julia hljs">FastMultipole.body_to_multipole!(system::VortexFilaments, args...) =
    FastMultipole.body_to_multipole!(Filament{Vortex}, system, args...)</code></pre><p>Ordinarily, a 3-dimensional vector potential, such as the stream function in 3-dimensional fluid dynamics, requires 3 separate expansions (1 for each dimension). It is worth noting that when <code>Vortex</code> elements are used, <code>FastMultipole</code> never actually computes the vector potential <span>$\vec{\psi}$</span>; rather, it computes two scalar components <span>$\phi$</span> and <span>$\chi$</span> of the Lamb-Helmholtz decomposition of the field as demonstrated by [<a href="../theory/#gumerov2013efficient">2</a>]. This allows us to reduce the number of expansions required to express the scalar-plus-vector potential from 4 to 2, thus reducing computational cost. It is also worth noting that <span>$\phi$</span> and <span>$\chi$</span> are not coordinate system-invariant fields, and thus cannot be used to evaluate scalar or vector potentials. In other words, when a <code>Vortex</code> kernel is used as a source in a FMM call, the <code>scalar_potential</code> should not be used.</p><h3 id="Buffer-Interface-Functions-2"><a class="docs-heading-anchor" href="#Buffer-Interface-Functions-2">Buffer Interface Functions</a><a class="docs-heading-anchor-permalink" href="#Buffer-Interface-Functions-2" title="Permalink"></a></h3><p>The buffer interface functions are defined for <code>VortexFilament</code> systems as follows:</p><pre><code class="language-julia hljs">function FastMultipole.source_system_to_buffer!(buffer, i_buffer, system::VortexFilaments, i_body)
    # position
    buffer[1:3,i_buffer] .= (system.x[1,i_body]  + system.x[2,i_body]) * 0.5

    # get regularization radius
    Γ = system.strength[i_body]
    # Γmag = norm(Γ)
    core_size = system.core_size[i_body]
    buffer[4,i_buffer] = system.core_size[i_body] + 0.5 * norm(system.x[2,i_body] - system.x[1,i_body])

    # remainding quantities
    buffer[5:7,i_buffer] .= Γ
    buffer[8:10,i_buffer] .= system.x[1,i_body]
    buffer[11:13,i_buffer] .= system.x[2,i_body]
    buffer[14,i_buffer] = core_size
end

Base.eltype(::VortexFilaments{TF}) where TF = TF

FastMultipole.data_per_body(::VortexFilaments) = 14

FastMultipole.get_position(system::VortexFilaments, i) = (system.x[1,i] + system.x[2,i]) * 0.5

FastMultipole.strength_dims(system::VortexFilaments) = 3

FastMultipole.get_n_bodies(system::VortexFilaments) = length(system.strength)

function FastMultipole.buffer_to_target_system!(target_system::VortexFilaments, i_target, ::DerivativesSwitch{PS,VS,GS}, target_buffer, i_buffer) where {PS,VS,GS}

    # extract from buffer
    PS &amp;&amp; (potential = FastMultipole.get_scalar_potential(target_buffer, i_buffer))
    VS &amp;&amp; (velocity = FastMultipole.get_gradient(target_buffer, i_buffer))
    GS &amp;&amp; (hessian = FastMultipole.get_hessian(target_buffer, i_buffer))

    # load into system
    PS &amp;&amp; (target_system.potential[i_target] += potential)
    VS &amp;&amp; (target_system.force[i_target] += velocity)
    GS &amp;&amp; (target_system.gradient[i_target] += hessian)

end</code></pre><p>First, we point out that the <code>source_system_to_buffer!</code> function stores a core size in row 14. Although it will not be used by any internal <code>FastMultipole</code> functions, it will be required by the <code>direct!</code> function. Since the columns of the buffer are sorted into an octree structure, they will not match the order of the original system; therefore, it is important to store essential body properties in additional rows of the buffer. We also note that the <code>get_position</code> function needs not return a previously-stored value; in this case, it computes the midpoint of the filament on the fly.</p><h3 id="Overloading-direct!-2"><a class="docs-heading-anchor" href="#Overloading-direct!-2">Overloading <code>direct!</code></a><a class="docs-heading-anchor-permalink" href="#Overloading-direct!-2" title="Permalink"></a></h3><p>The <code>FastMultipole.direct!</code> function is overloaded for <code>VortexFilaments</code> systems as follows:</p><pre><code class="language-julia hljs">function get_δ(distance, core_size)
    δ = distance &lt; core_size ? (distance-core_size) * (distance-core_size) : zero(distance)
    return δ
end

function vortex_filament_finite_core_2(x1,x2,xt,q,core_size)
    # intermediate values
    r1 = xt - x1
    r2 = xt - x2

    nr1 = norm(r1)
    nr2 = norm(r2)

    num = cross(r1, r2)
    denom = nr1 * nr2 + dot(r1, r2)

    # core size comes into play here
    distance_1 = norm((x1+x2)*0.5 - xt)
    δ1 = get_δ(distance_1, core_size)

    distance_2 = norm(x1 - xt)
    δ2 = get_δ(distance_2, core_size)

    distance_3 = norm(x2 - xt)
    δ3 = get_δ(distance_3, core_size)

    # desingularized terms
    f1 = num/(denom + δ1)
    f2 = 1/(nr1+δ2)
    f3 = 1/(nr2+δ3)

    # evaluate velocity
    V = (f1*(f2+f3))/(4*pi) * q

    return V
end

function FastMultipole.direct!(target_system, target_index, derivatives_switch::DerivativesSwitch{PS,VS,GS}, source_system::VortexFilaments, source_buffer, source_index) where {PS,VS,GS}
    for i_source in source_index
        x1 = FastMultipole.get_vertex(source_buffer, source_system, i_source, 1)
        x2 = FastMultipole.get_vertex(source_buffer, source_system, i_source, 2)
        q = FastMultipole.get_strength(source_buffer, source_system, i_source)
        core_size = source_buffer[14, i_source]

        for i_target in target_index
            xt = FastMultipole.get_position(target_system, i_target)

            if VS
                # determine sign of q
                q_mag = norm(q) * sign(dot(q, x2-x1))

                # calculate velocity
                v = vortex_filament_finite_core_2(x1,x2,xt,q_mag,core_size)
                FastMultipole.set_gradient!(target_system, i_target, v)
            end
        end
    end
end</code></pre><p>Note that <code>core_size</code> is retrieved from the buffer matrix rather than from <code>source_system</code> directly, as discussed previously.</p><h3 id="Running-the-FMM-2"><a class="docs-heading-anchor" href="#Running-the-FMM-2">Running the FMM</a><a class="docs-heading-anchor-permalink" href="#Running-the-FMM-2" title="Permalink"></a></h3><p>Let&#39;s try this out on a vortex filament system. The <code>fmm!</code> function is called in the same way as for the gravitational example, but with the <code>VortexFilaments</code> system:</p><pre><code class="language-julia hljs">using LinearAlgebra

# create system
function generate_filament_field(n_filaments, length_scale; strength_scale=1/n_filaments)
    centers = rand(SVector{3,Float64}, n_filaments)
    pts = zeros(SVector{3,Float64}, 2, n_filaments)
    strength_vec= zeros(SVector{3,Float64}, n_filaments)
    for (i,center) in enumerate(centers)
        dx = (rand(SVector{3,Float64}) * 2 .- 1.0) * 0.5 * length_scale
        pts[1,i] = center - dx
        pts[2,i] = center + dx
        Γ = dx / norm(dx) * rand() * strength_scale
        strength_vec[i] = Γ
    end

    # create filaments
    core_size = fill(1e-2, n_filaments)
    ε_tol = fill(1e-4, n_filaments)
    potential = zeros(length(strength_vec))
    gradient = zeros(SVector{3,Float64}, length(strength_vec))
    hessian = zeros(SMatrix{3,3,Float64,9}, length(strength_vec))

    return VortexFilaments(pts, strength_vec, core_size, ε_tol, potential, gradient, hessian)
end

n_filaments = 1000
length_scale = 1.0 / n_filaments^(1/3)
filaments = generate_filament_field(n_filaments, length_scale; strength_scale=1/n_filaments)

# run FMM
_, cache, _ = fmm!(filaments; lamb_helmholtz=true, scalar_potential=false, gradient=true)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((leaf_size_source = [20], expansion_order = 5, multipole_acceptance = 0.4), (target_buffers = ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), target_small_buffers = [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]], source_buffers = ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.15364977568198596 0.004438653682646284 … 0.7412416553292829 0.7768139355631294; 0.01 0.01 … 0.01 0.01],), source_small_buffers = [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5044114558025989, 0.5007419764808742, 0.5006583937325841], [0.5044114558025989, 0.5007419764808742, 0.5006583937325841], 0.8581002230324437, 0.8581002230324437, [0.4954472963340413, 0.4986277692935247, 0.49784978451488304], [0.4954472963340413, 0.4986277692935247, 0.49784978451488304], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[1:123], 8, 10:17, 1, -1, [0.2542303485656898, 0.25007509991236115, 0.25074920648588944], [0.2542303485656898, 0.25007509991236115, 0.25074920648588944], 0.41578199659581905, 0.41578199659581905, [0.24526618909713205, 0.2479608927250117, 0.24794059726818823], [0.24526618909713205, 0.2479608927250117, 0.24794059726818823], 0.0), Branch{Float64, 1}([120], UnitRange{Int64}[124:243], 8, 18:25, 1, -1, [0.7516243177156123, 0.2509200877984046, 0.2503448079300079], [0.7516243177156123, 0.2509200877984046, 0.2503448079300079], 0.4266120234285119, 0.4266120234285119, [0.24680626332089606, 0.2482817964762346, 0.24405782167051993], [0.24680626332089606, 0.2482817964762346, 0.24405782167051993], 0.0), Branch{Float64, 1}([115], UnitRange{Int64}[244:358], 8, 26:33, 1, -1, [0.2526554161853759, 0.7496454189704391, 0.2515478215279864], [0.2526554161853759, 0.7496454189704391, 0.2515478215279864], 0.40604153697960177, 0.40604153697960177, [0.2424821823392117, 0.24854250731581073, 0.24215722816854712], [0.2424821823392117, 0.24854250731581073, 0.24215722816854712], 0.0), Branch{Float64, 1}([128], UnitRange{Int64}[359:486], 8, 34:41, 1, -1, [0.7512168371733566, 0.7544027682643714, 0.25196676412384506], [0.7512168371733566, 0.7544027682643714, 0.25196676412384506], 0.41140021268176136, 0.41140021268176136, [0.24518097756405755, 0.2423828172773036, 0.24631391467731628], [0.24518097756405755, 0.2423828172773036, 0.24631391467731628], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[487:611], 8, 42:49, 1, -1, [0.2615837372432516, 0.2520462106455035, 0.7609197959015138], [0.2615837372432516, 0.2520462106455035, 0.7609197959015138], 0.39311090065745397, 0.39311090065745397, [0.23174503216826497, 0.24688254433858625, 0.22490045471800146], [0.23174503216826497, 0.24688254433858625, 0.22490045471800146], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[612:737], 8, 50:57, 1, -1, [0.7497230281995486, 0.25215008014048756, 0.7503775840720435], [0.7497230281995486, 0.25215008014048756, 0.7503775840720435], 0.40850776824660795, 0.40850776824660795, [0.24469152054139087, 0.24627902672027047, 0.2481305941754237], [0.24469152054139087, 0.24627902672027047, 0.2481305941754237], 0.0), Branch{Float64, 1}([112], UnitRange{Int64}[738:849], 8, 58:65, 1, -1, [0.25843882604414375, 0.7491258547756303, 0.74959327365901], [0.25843882604414375, 0.7491258547756303, 0.74959327365901], 0.4092304512412248, 0.4092304512412248, [0.24474430906253436, 0.24698490887005442, 0.24797545513292396], [0.24474430906253436, 0.24698490887005442, 0.24797545513292396], 0.0), Branch{Float64, 1}([151], UnitRange{Int64}[850:1000], 8, 66:73, 1, -1, [0.7535450835807624, 0.7537771863373883, 0.7476207650540311], [0.7535450835807624, 0.7537771863373883, 0.7476207650540311], 0.40645857505777144, 0.40645857505777144, [0.24631366855587777, 0.24559255943701053, 0.24651548757378527], [0.24631366855587777, 0.24559255943701053, 0.24651548757378527], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[1:22], 0, 74:73, 2, 1, [0.12353421619908211, 0.12072358540496836, 0.12137346595871273], [0.12353421619908211, 0.12072358540496836, 0.12137346595871273], 0.19094566599530993, 0.19094566599530993, [0.11457005673052434, 0.11847804351410035, 0.11291343837352624], [0.11457005673052434, 0.11847804351410035, 0.11291343837352624], 0.0)  …  Branch{Float64, 1}([17], UnitRange{Int64}[821:837], 0, 74:73, 8, 55, [0.14694650125714664, 0.8811075100726821, 0.8885021634574943], [0.14694650125714664, 0.8811075100726821, 0.8885021634574943], 0.14833351143997375, 0.14833351143997375, [0.10516980127035841, 0.11500325357300267, 0.10906656533443959], [0.10516980127035841, 0.11500325357300267, 0.10906656533443959], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[838:849], 0, 74:73, 8, 56, [0.3838756377343044, 0.8700844478520311, 0.8802612968775286], [0.3838756377343044, 0.8700844478520311, 0.8802612968775286], 0.18951842613856443, 0.18951842613856443, [0.11930749737237373, 0.10656510632276484, 0.11550449976637822], [0.11930749737237373, 0.10656510632276484, 0.11550449976637822], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[850:871], 0, 74:73, 9, 57, [0.6193237240639295, 0.6316294712003265, 0.6321855163476602], [0.6193237240639295, 0.6316294712003265, 0.6321855163476602], 0.17757794707751376, 0.17757794707751376, [0.11080495836781423, 0.11507060261415958, 0.11581325444460999], [0.11080495836781423, 0.11507060261415958, 0.11581325444460999], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[872:887], 0, 74:73, 9, 58, [0.8819887131830135, 0.636161130633165, 0.6039050657981604], [0.8819887131830135, 0.636161130633165, 0.6039050657981604], 0.18065887453223245, 0.18065887453223245, [0.09843809613723986, 0.11126443141417819, 0.10279978831791459], [0.09843809613723986, 0.11126443141417819, 0.10279978831791459], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[888:904], 0, 74:73, 9, 59, [0.6209856526777608, 0.8818427763412486, 0.6185652061390131], [0.6209856526777608, 0.8818427763412486, 0.6185652061390131], 0.16107575567363802, 0.16107575567363802, [0.10895059401004126, 0.1100172733112128, 0.10220805558901713], [0.10895059401004126, 0.1100172733112128, 0.10220805558901713], 0.0), Branch{Float64, 1}([19], UnitRange{Int64}[905:923], 0, 74:73, 9, 60, [0.8885059487384226, 0.8726045150915596, 0.6267809189374195], [0.8885059487384226, 0.8726045150915596, 0.6267809189374195], 0.17775803765296308, 0.17775803765296308, [0.10768176476301128, 0.11572774921247098, 0.09898393684472662], [0.10768176476301128, 0.11572774921247098, 0.09898393684472662], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[924:940], 0, 74:73, 9, 61, [0.6250871663542622, 0.6362433315295803, 0.8632772657288873], [0.6250871663542622, 0.6362433315295803, 0.8632772657288873], 0.15806757823978468, 0.15806757823978468, [0.11785575132937764, 0.10166275648395395, 0.11142412169168381], [0.11785575132937764, 0.10166275648395395, 0.11142412169168381], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[941:957], 0, 74:73, 9, 62, [0.8864447733551086, 0.605597724517055, 0.8452772723256606], [0.8864447733551086, 0.605597724517055, 0.8452772723256606], 0.1601220017198606, 0.1601220017198606, [0.11341397878153159, 0.09741309761667727, 0.09473642657438575], [0.11341397878153159, 0.09741309761667727, 0.09473642657438575], 0.0), Branch{Float64, 1}([25], UnitRange{Int64}[958:982], 0, 74:73, 9, 63, [0.6316515377692793, 0.8761883748433387, 0.8733175472338881], [0.6316515377692793, 0.8761883748433387, 0.8733175472338881], 0.174388731851731, 0.174388731851731, [0.12146154324292668, 0.12318137093106019, 0.12081870539392825], [0.12146154324292668, 0.12318137093106019, 0.12081870539392825], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8780944355088784, 0.8773098662755738, 0.860199490696723], [0.8780944355088784, 0.8773098662755738, 0.860199490696723], 0.16292315926336165, 0.16292315926336165, [0.11686027717266723, 0.1164488039429803, 0.10013546591301625], [0.11686027717266723, 0.1164488039429803, 0.10013546591301625], 0.0)], [0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; … ;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([109, 184, 208, 235, 254, 331, 382, 411, 453, 455  …  530, 547, 552, 626, 727, 732, 737, 799, 817, 927],), ([159, 44, 328, 722, 838, 612, 693, 801, 924, 58  …  192, 692, 500, 837, 175, 208, 106, 379, 295, 358],), ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]], 5, [20]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5055365623813514, 0.5004118100269904, 0.5003693683409137], [0.5044114558025989, 0.5007419764808742, 0.5006583937325841], 0.9252366995359602, 0.8581002230324437, [0.569076965589871, 0.5770219850018689, 0.5759833068078916], [0.4954472963340413, 0.4986277692935247, 0.49784978451488304], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[1:123], 8, 10:17, 1, -1, [0.24518592618758692, 0.2534648155754231, 0.2407362879359385], [0.2542303485656898, 0.25007509991236115, 0.25074920648588944], 0.48232067106584864, 0.41578199659581905, [0.30872632939610645, 0.31492924087076424, 0.3163502264029163], [0.24526618909713205, 0.2479608927250117, 0.24794059726818823], 0.0), Branch{Float64, 1}([120], UnitRange{Int64}[124:243], 8, 18:25, 1, -1, [0.7477881365036596, 0.2561056763476732, 0.2638903546224808], [0.7516243177156123, 0.2509200877984046, 0.2503448079300079], 0.4919983212179789, 0.4266120234285119, [0.32682539146756273, 0.3168045889342847, 0.3143675843366661], [0.24680626332089606, 0.2482817964762346, 0.24405782167051993], 0.0), Branch{Float64, 1}([115], UnitRange{Int64}[244:358], 8, 26:33, 1, -1, [0.2510559921099311, 0.7503071347819479, 0.2553684903569946], [0.2526554161853759, 0.7496454189704391, 0.2515478215279864], 0.47424591805577354, 0.40604153697960177, [0.31136608914512365, 0.30910418199483813, 0.3125815334820641], [0.2424821823392117, 0.24854250731581073, 0.24215722816854712], 0.0), Branch{Float64, 1}([128], UnitRange{Int64}[359:486], 8, 34:41, 1, -1, [0.745274756419821, 0.748827420080111, 0.24618478877695252], [0.7512168371733566, 0.7544027682643714, 0.25196676412384506], 0.48586352472680017, 0.41140021268176136, [0.311516370586683, 0.32211222486046975, 0.31567472895229876], [0.24518097756405755, 0.2423828172773036, 0.24631391467731628], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[487:611], 8, 42:49, 1, -1, [0.25885524918826863, 0.2546885507881843, 0.7713209298120647], [0.2615837372432516, 0.2520462106455035, 0.7609197959015138], 0.46286949492509166, 0.39311090065745397, [0.29913072038979494, 0.33129872576306274, 0.2922650476301434], [0.23174503216826497, 0.24688254433858625, 0.22490045471800146], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[612:737], 8, 50:57, 1, -1, [0.7589969915559551, 0.2534709844561074, 0.7345664679909352], [0.7497230281995486, 0.25215008014048756, 0.7503775840720435], 0.4674472426165294, 0.40850776824660795, [0.3053847680090085, 0.31204914873095757, 0.30844203700490636], [0.24469152054139087, 0.24627902672027047, 0.2481305941754237], 0.0), Branch{Float64, 1}([112], UnitRange{Int64}[738:849], 8, 58:65, 1, -1, [0.25560961888190625, 0.7499724770575975, 0.7568198221284095], [0.25843882604414375, 0.7491258547756303, 0.74959327365901], 0.48022098062988905, 0.4092304512412248, [0.31864602892896043, 0.31113017871149906, 0.3195328530203958], [0.24474430906253436, 0.24698490887005442, 0.24797545513292396], 0.0), Branch{Float64, 1}([151], UnitRange{Int64}[850:1000], 8, 66:73, 1, -1, [0.7516068858244844, 0.7617578402976709, 0.7482986334639216], [0.7535450835807624, 0.7537771863373883, 0.7476207650540311], 0.45554103840525756, 0.40645857505777144, [0.31746644815608027, 0.31567595473118837, 0.30587867488784803], [0.24631366855587777, 0.24559255943701053, 0.24651548757378527], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[1:22], 0, 74:73, 2, 1, [0.1119134768485247, 0.11809931909296659, 0.10558033452246798], [0.12353421619908211, 0.12072358540496836, 0.12137346595871273], 0.24918445523081567, 0.19094566599530993, [0.17545388005704426, 0.17956374438830772, 0.16818922234162922], [0.11457005673052434, 0.11847804351410035, 0.11291343837352624], 0.0)  …  Branch{Float64, 1}([17], UnitRange{Int64}[821:837], 0, 74:73, 8, 55, [0.13231060773958053, 0.8843680128029856, 0.8958631171579591], [0.14694650125714664, 0.8811075100726821, 0.8885021634574943], 0.21095269232297575, 0.14833351143997375, [0.16768903727394308, 0.17673464296611097, 0.1620261645454678], [0.10516980127035841, 0.11500325357300267, 0.10906656533443959], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[838:849], 0, 74:73, 8, 56, [0.3863443206988628, 0.8648489630139692, 0.8862153753770756], [0.3838756377343044, 0.8700844478520311, 0.8802612968775286], 0.24881412525853938, 0.18951842613856443, [0.18791132711200387, 0.16113895466907036, 0.19013729977172966], [0.11930749737237373, 0.10656510632276484, 0.11550449976637822], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[850:871], 0, 74:73, 9, 57, [0.6233180336566873, 0.6369208625888162, 0.6517472756687864], [0.6193237240639295, 0.6316294712003265, 0.6321855163476602], 0.23553038989027247, 0.17757794707751376, [0.18088937914854375, 0.16872567948777728, 0.17382322026968255], [0.11080495836781423, 0.11507060261415958, 0.11581325444460999], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[872:887], 0, 74:73, 9, 58, [0.8679380894173007, 0.6345472591650124, 0.6134679698556638], [0.8819887131830135, 0.636161130633165, 0.6039050657981604], 0.23250824397207082, 0.18065887453223245, [0.14791088465317725, 0.17640171516398107, 0.1707485778157537], [0.09843809613723986, 0.11126443141417819, 0.10279978831791459], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[888:904], 0, 74:73, 9, 59, [0.615928214146104, 0.8656931135054877, 0.6150544405845947], [0.6209856526777608, 0.8818427763412486, 0.6185652061390131], 0.22383986308858655, 0.16107575567363802, [0.17157266315944653, 0.17568689980192875, 0.17263448200852116], [0.10895059401004126, 0.1100172733112128, 0.10220805558901713], 0.0), Branch{Float64, 1}([19], UnitRange{Int64}[905:923], 0, 74:73, 9, 60, [0.8826037847216215, 0.877739906751049, 0.6223968276311791], [0.8885059487384226, 0.8726045150915596, 0.6267809189374195], 0.23024317038211445, 0.17775803765296308, [0.16447897474899809, 0.16567199579499547, 0.16606740215375504], [0.10768176476301128, 0.11572774921247098, 0.09898393684472662], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[924:940], 0, 74:73, 9, 61, [0.6150202814430191, 0.6380609520762941, 0.8595504556397298], [0.6250871663542622, 0.6362433315295803, 0.8632772657288873], 0.2271204093519339, 0.15806757823978468, [0.18087984377461508, 0.15280234347123456, 0.18562091347718224], [0.11785575132937764, 0.10166275648395395, 0.11142412169168381], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[941:957], 0, 74:73, 9, 62, [0.8872227187077826, 0.6141716830300381, 0.8449375947404147], [0.8864447733551086, 0.605597724517055, 0.8452772723256606], 0.21965687949500118, 0.1601220017198606, [0.16736033983725918, 0.16808979746355557, 0.1609167268710101], [0.11341397878153159, 0.09741309761667727, 0.09473642657438575], 0.0), Branch{Float64, 1}([25], UnitRange{Int64}[958:982], 0, 74:73, 9, 63, [0.6425472323075379, 0.8848544112806114, 0.8758695221819778], [0.6316515377692793, 0.8761883748433387, 0.8733175472338881], 0.24740381092946645, 0.174388731851731, [0.1946999273208918, 0.1925793837482479, 0.17830778616979182], [0.12146154324292668, 0.12318137093106019, 0.12081870539392825], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8862634716697911, 0.8771727331128197, 0.8560010579551269], [0.8780944355088784, 0.8773098662755738, 0.860199490696723], 0.2247593838660758, 0.16292315926336165, [0.18280986231077356, 0.17356248396276086, 0.16060155793158537], [0.11686027717266723, 0.1164488039429803, 0.10013546591301625], 0.0)], [0.0 0.0; 0.0 0.0;;; 9.085401100762653e-5 -0.00029344409304671017; 0.0 0.0;;; 3.823963978375807e-5 0.00015250271814770005; 6.795318534133415e-5 -0.0007561534385155661;;; … ;;; -1.790005980911306e-8 -1.078520760115675e-7; -1.4011657499814657e-8 1.0126091527229683e-7;;; -4.814109699944375e-9 -1.9944863823823672e-8; -7.109118826695417e-9 -3.962121424078921e-8;;; 5.138542000316878e-9 2.094038490735147e-9; -9.12173413916801e-10 8.280344436702802e-9;;;; 0.0 0.0; 0.0 0.0;;; -1.953990413859174e-5 -0.0002011014179534245; 0.0 0.0;;; -3.5523695202942324e-5 6.422021012947684e-5; 7.5458923372361575e-6 -0.0002342978822541968;;; … ;;; -1.0916897570353017e-9 2.3887207436165234e-9; -8.328290227506778e-10 -1.072703206861159e-9;;; 8.907813005664231e-14 8.362333538910048e-10; -4.659517355504335e-10 5.701124575085474e-10;;; -2.4753775843400888e-11 -1.959683879001754e-11; 4.829815896062473e-12 -3.9343229531688795e-11;;;; 0.0 0.0; 0.0 0.0;;; 2.4773187066684562e-6 -0.0004010775965237804; 0.0 0.0;;; -1.0012368551575646e-5 0.00017998835014523996; 2.721805342473138e-5 -3.1605231185122485e-5;;; … ;;; -9.482737646627736e-10 -2.523302991813858e-9; -5.043367352567293e-10 1.157182044043473e-9;;; -3.066936804608569e-10 1.9241077580352163e-9; -8.489503750451262e-10 -1.059349363366908e-9;;; 5.31696546197748e-11 5.551987667144033e-10; -1.4576667412608524e-10 2.0999583333092753e-10;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; -8.954052436363107e-7 -1.2527502708677482e-5; 0.0 0.0;;; 5.736876837428257e-6 2.2268135531854217e-5; 4.773132605699973e-6 -5.551873794592289e-5;;; … ;;; 1.6492101975921583e-12 3.085808112253758e-11; -3.7101211848752436e-13 -4.241576627481029e-11;;; 3.1668427304776625e-12 1.0066860509896021e-11; 3.2767092348059427e-12 -1.0580161576556914e-12;;; -1.1835126754906163e-12 5.179934226964712e-13; 1.6434445910505196e-13 2.042537474066257e-12;;;; 0.0 0.0; 0.0 0.0;;; 3.86494546754068e-6 -2.605024256874307e-5; 0.0 0.0;;; 4.258828086429907e-7 0.00010069775247924459; -7.690948288703633e-7 -8.528065106352436e-5;;; … ;;; -7.722195707105061e-12 -2.1004746878341367e-11; 2.024642909242793e-12 -5.152079683143322e-11;;; -3.340706983176114e-12 -2.3507629525794842e-11; 2.43859873185525e-13 -3.152313923191654e-11;;; -1.4933693641907782e-13 -8.845824662081519e-13; 2.656215988180514e-13 -1.4158587857429631e-11;;;; 0.0 0.0; 0.0 0.0;;; -5.811484068512537e-6 -0.00017787077579590804; 0.0 0.0;;; 2.9262991179032653e-6 5.26856595827039e-5; -4.712412052644027e-6 3.295842415180757e-5;;; … ;;; -3.908316695388103e-12 2.634946857374717e-11; -7.595907513155775e-14 1.0397558024368549e-10;;; 1.2872354689057564e-12 2.4779428018179843e-11; 2.1227442239813942e-13 -1.3685980135067538e-11;;; -9.360663582398734e-13 6.9190249450949456e-12; -2.7053541867764523e-13 -5.5671405725762424e-12], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([109, 184, 208, 235, 254, 331, 382, 411, 453, 455  …  530, 547, 552, 626, 727, 732, 737, 799, 817, 927],), ([159, 44, 328, 722, 838, 612, 693, 801, 924, 58  …  192, 692, 500, 837, 175, 208, 106, 379, 295, 358],), ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.15364977568198596 0.004438653682646284 … 0.7412416553292829 0.7768139355631294; 0.01 0.01 … 0.01 0.01],), [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]], 5, [20]), StaticArraysCore.SVector{2, Int32}[], StaticArraysCore.SVector{2, Int32}[[10, 10], [10, 11], [10, 12], [10, 13], [10, 14], [10, 15], [10, 16], [10, 17], [10, 18], [10, 19]  …  [73, 64], [73, 65], [73, 66], [73, 67], [73, 68], [73, 69], [73, 70], [73, 71], [73, 72], [73, 73]], (DerivativesSwitch{false, true, false}(),), true)</code></pre><p>We set <code>lamb_helmholtz=true</code> because the vortex filament model induces a vector potential.</p><h3 id="Optimal-Leaf-Size"><a class="docs-heading-anchor" href="#Optimal-Leaf-Size">Optimal Leaf Size</a><a id="Optimal-Leaf-Size-1"></a><a class="docs-heading-anchor-permalink" href="#Optimal-Leaf-Size" title="Permalink"></a></h3><p>We can request <code>FastMultipole</code> to predict the optimal leaf size for our system by setting <code>tune=true</code> in the <code>fmm!</code> call. This performs best when <code>interaction_list_method=SelfTuning()</code> on a single thread, but still functions well for other choices. If <code>tune=true</code>, benchmarks will be used to estimate the leaf size at which the cost of direct calculations is approximately equal to expansion calculations. It is returned as part of a named tuple as the first returned value of <code>fmm!</code>, which can be splatted as a keyword argument in subsequent <code>fmm!</code> calls:</p><pre><code class="language-julia hljs"># get optimal leaf size
println(&quot;#--- default leaf size ---#\n&quot;)
@time optargs, _ = fmm!(filaments; tune=true, lamb_helmholtz=true, scalar_potential=false, gradient=true, cache...)

# run again with optimal leaf size
println(&quot;\n#--- optimal leaf size ---#\n&quot;)
@time fmm!(filaments; lamb_helmholtz=true, scalar_potential=false, gradient=true, cache..., optargs...)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">((leaf_size_source = [10], expansion_order = 1, multipole_acceptance = 0.4), (target_buffers = ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), target_small_buffers = [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]], source_buffers = ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.15364977568198596 0.004438653682646284 … 0.7412416553292829 0.7768139355631294; 0.01 0.01 … 0.01 0.01],), source_small_buffers = [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5044114558025989, 0.5007419764808742, 0.5006583937325841], [0.5044114558025989, 0.5007419764808742, 0.5006583937325841], 0.8581002230324437, 0.8581002230324437, [0.4954472963340413, 0.4986277692935247, 0.49784978451488304], [0.4954472963340413, 0.4986277692935247, 0.49784978451488304], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[1:123], 8, 10:17, 1, -1, [0.2542303485656898, 0.25007509991236115, 0.25074920648588944], [0.2542303485656898, 0.25007509991236115, 0.25074920648588944], 0.41578199659581905, 0.41578199659581905, [0.24526618909713205, 0.2479608927250117, 0.24794059726818823], [0.24526618909713205, 0.2479608927250117, 0.24794059726818823], 0.0), Branch{Float64, 1}([120], UnitRange{Int64}[124:243], 8, 18:25, 1, -1, [0.7516243177156123, 0.2509200877984046, 0.2503448079300079], [0.7516243177156123, 0.2509200877984046, 0.2503448079300079], 0.4266120234285119, 0.4266120234285119, [0.24680626332089606, 0.2482817964762346, 0.24405782167051993], [0.24680626332089606, 0.2482817964762346, 0.24405782167051993], 0.0), Branch{Float64, 1}([115], UnitRange{Int64}[244:358], 8, 26:33, 1, -1, [0.2526554161853759, 0.7496454189704391, 0.2515478215279864], [0.2526554161853759, 0.7496454189704391, 0.2515478215279864], 0.40604153697960177, 0.40604153697960177, [0.2424821823392117, 0.24854250731581073, 0.24215722816854712], [0.2424821823392117, 0.24854250731581073, 0.24215722816854712], 0.0), Branch{Float64, 1}([128], UnitRange{Int64}[359:486], 8, 34:41, 1, -1, [0.7512168371733566, 0.7544027682643714, 0.25196676412384506], [0.7512168371733566, 0.7544027682643714, 0.25196676412384506], 0.41140021268176136, 0.41140021268176136, [0.24518097756405755, 0.2423828172773036, 0.24631391467731628], [0.24518097756405755, 0.2423828172773036, 0.24631391467731628], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[487:611], 8, 42:49, 1, -1, [0.2615837372432516, 0.2520462106455035, 0.7609197959015138], [0.2615837372432516, 0.2520462106455035, 0.7609197959015138], 0.39311090065745397, 0.39311090065745397, [0.23174503216826497, 0.24688254433858625, 0.22490045471800146], [0.23174503216826497, 0.24688254433858625, 0.22490045471800146], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[612:737], 8, 50:57, 1, -1, [0.7497230281995486, 0.25215008014048756, 0.7503775840720435], [0.7497230281995486, 0.25215008014048756, 0.7503775840720435], 0.40850776824660795, 0.40850776824660795, [0.24469152054139087, 0.24627902672027047, 0.2481305941754237], [0.24469152054139087, 0.24627902672027047, 0.2481305941754237], 0.0), Branch{Float64, 1}([112], UnitRange{Int64}[738:849], 8, 58:65, 1, -1, [0.25843882604414375, 0.7491258547756303, 0.74959327365901], [0.25843882604414375, 0.7491258547756303, 0.74959327365901], 0.4092304512412248, 0.4092304512412248, [0.24474430906253436, 0.24698490887005442, 0.24797545513292396], [0.24474430906253436, 0.24698490887005442, 0.24797545513292396], 0.0), Branch{Float64, 1}([151], UnitRange{Int64}[850:1000], 8, 66:73, 1, -1, [0.7535450835807624, 0.7537771863373883, 0.7476207650540311], [0.7535450835807624, 0.7537771863373883, 0.7476207650540311], 0.40645857505777144, 0.40645857505777144, [0.24631366855587777, 0.24559255943701053, 0.24651548757378527], [0.24631366855587777, 0.24559255943701053, 0.24651548757378527], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[1:22], 0, 74:73, 2, 1, [0.12353421619908211, 0.12072358540496836, 0.12137346595871273], [0.12353421619908211, 0.12072358540496836, 0.12137346595871273], 0.19094566599530993, 0.19094566599530993, [0.11457005673052434, 0.11847804351410035, 0.11291343837352624], [0.11457005673052434, 0.11847804351410035, 0.11291343837352624], 0.0)  …  Branch{Float64, 1}([17], UnitRange{Int64}[821:837], 0, 74:73, 8, 55, [0.14694650125714664, 0.8811075100726821, 0.8885021634574943], [0.14694650125714664, 0.8811075100726821, 0.8885021634574943], 0.14833351143997375, 0.14833351143997375, [0.10516980127035841, 0.11500325357300267, 0.10906656533443959], [0.10516980127035841, 0.11500325357300267, 0.10906656533443959], 0.0), Branch{Float64, 1}([12], UnitRange{Int64}[838:849], 0, 74:73, 8, 56, [0.3838756377343044, 0.8700844478520311, 0.8802612968775286], [0.3838756377343044, 0.8700844478520311, 0.8802612968775286], 0.18951842613856443, 0.18951842613856443, [0.11930749737237373, 0.10656510632276484, 0.11550449976637822], [0.11930749737237373, 0.10656510632276484, 0.11550449976637822], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[850:871], 0, 74:73, 9, 57, [0.6193237240639295, 0.6316294712003265, 0.6321855163476602], [0.6193237240639295, 0.6316294712003265, 0.6321855163476602], 0.17757794707751376, 0.17757794707751376, [0.11080495836781423, 0.11507060261415958, 0.11581325444460999], [0.11080495836781423, 0.11507060261415958, 0.11581325444460999], 0.0), Branch{Float64, 1}([16], UnitRange{Int64}[872:887], 0, 74:73, 9, 58, [0.8819887131830135, 0.636161130633165, 0.6039050657981604], [0.8819887131830135, 0.636161130633165, 0.6039050657981604], 0.18065887453223245, 0.18065887453223245, [0.09843809613723986, 0.11126443141417819, 0.10279978831791459], [0.09843809613723986, 0.11126443141417819, 0.10279978831791459], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[888:904], 0, 74:73, 9, 59, [0.6209856526777608, 0.8818427763412486, 0.6185652061390131], [0.6209856526777608, 0.8818427763412486, 0.6185652061390131], 0.16107575567363802, 0.16107575567363802, [0.10895059401004126, 0.1100172733112128, 0.10220805558901713], [0.10895059401004126, 0.1100172733112128, 0.10220805558901713], 0.0), Branch{Float64, 1}([19], UnitRange{Int64}[905:923], 0, 74:73, 9, 60, [0.8885059487384226, 0.8726045150915596, 0.6267809189374195], [0.8885059487384226, 0.8726045150915596, 0.6267809189374195], 0.17775803765296308, 0.17775803765296308, [0.10768176476301128, 0.11572774921247098, 0.09898393684472662], [0.10768176476301128, 0.11572774921247098, 0.09898393684472662], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[924:940], 0, 74:73, 9, 61, [0.6250871663542622, 0.6362433315295803, 0.8632772657288873], [0.6250871663542622, 0.6362433315295803, 0.8632772657288873], 0.15806757823978468, 0.15806757823978468, [0.11785575132937764, 0.10166275648395395, 0.11142412169168381], [0.11785575132937764, 0.10166275648395395, 0.11142412169168381], 0.0), Branch{Float64, 1}([17], UnitRange{Int64}[941:957], 0, 74:73, 9, 62, [0.8864447733551086, 0.605597724517055, 0.8452772723256606], [0.8864447733551086, 0.605597724517055, 0.8452772723256606], 0.1601220017198606, 0.1601220017198606, [0.11341397878153159, 0.09741309761667727, 0.09473642657438575], [0.11341397878153159, 0.09741309761667727, 0.09473642657438575], 0.0), Branch{Float64, 1}([25], UnitRange{Int64}[958:982], 0, 74:73, 9, 63, [0.6316515377692793, 0.8761883748433387, 0.8733175472338881], [0.6316515377692793, 0.8761883748433387, 0.8733175472338881], 0.174388731851731, 0.174388731851731, [0.12146154324292668, 0.12318137093106019, 0.12081870539392825], [0.12146154324292668, 0.12318137093106019, 0.12081870539392825], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 74:73, 9, 64, [0.8780944355088784, 0.8773098662755738, 0.860199490696723], [0.8780944355088784, 0.8773098662755738, 0.860199490696723], 0.16292315926336165, 0.16292315926336165, [0.11686027717266723, 0.1164488039429803, 0.10013546591301625], [0.11686027717266723, 0.1164488039429803, 0.10013546591301625], 0.0)], [0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0;;; 0.0 0.0; 0.0 0.0], UnitRange{Int64}[1:1, 2:9, 10:73], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  64, 65, 66, 67, 68, 69, 70, 71, 72, 73], ([109, 184, 208, 235, 254, 331, 382, 411, 453, 455  …  530, 547, 552, 626, 727, 732, 737, 799, 817, 927],), ([159, 44, 328, 722, 838, 612, 693, 801, 924, 58  …  192, 692, 500, 837, 175, 208, 106, 379, 295, 358],), ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.0 0.0 … 0.0 0.0; 0.0 0.0 … 0.0 0.0],), [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]], 1, [20]), Tree{Float64, 1}(Branch{Float64, 1}[Branch{Float64, 1}([1000], UnitRange{Int64}[1:1000], 8, 2:9, 0, -1, [0.5055365623813514, 0.5004118100269904, 0.5003693683409137], [0.5044114558025989, 0.5007419764808742, 0.5006583937325841], 0.9252366995359602, 0.8581002230324437, [0.569076965589871, 0.5770219850018689, 0.5759833068078916], [0.4954472963340413, 0.4986277692935247, 0.49784978451488304], 0.0), Branch{Float64, 1}([123], UnitRange{Int64}[1:123], 8, 10:17, 1, -1, [0.24518592618758692, 0.2534648155754231, 0.2407362879359385], [0.2542303485656898, 0.25007509991236115, 0.25074920648588944], 0.48232067106584864, 0.41578199659581905, [0.30872632939610645, 0.31492924087076424, 0.3163502264029163], [0.24526618909713205, 0.2479608927250117, 0.24794059726818823], 0.0), Branch{Float64, 1}([120], UnitRange{Int64}[124:243], 8, 18:25, 1, -1, [0.7477881365036596, 0.2561056763476732, 0.2638903546224808], [0.7516243177156123, 0.2509200877984046, 0.2503448079300079], 0.4919983212179789, 0.4266120234285119, [0.32682539146756273, 0.3168045889342847, 0.3143675843366661], [0.24680626332089606, 0.2482817964762346, 0.24405782167051993], 0.0), Branch{Float64, 1}([115], UnitRange{Int64}[244:358], 8, 26:33, 1, -1, [0.2510559921099311, 0.7503071347819479, 0.2553684903569946], [0.2526554161853759, 0.7496454189704391, 0.2515478215279864], 0.47424591805577354, 0.40604153697960177, [0.31136608914512365, 0.30910418199483813, 0.3125815334820641], [0.2424821823392117, 0.24854250731581073, 0.24215722816854712], 0.0), Branch{Float64, 1}([128], UnitRange{Int64}[359:486], 8, 34:41, 1, -1, [0.745274756419821, 0.748827420080111, 0.24618478877695252], [0.7512168371733566, 0.7544027682643714, 0.25196676412384506], 0.48586352472680017, 0.41140021268176136, [0.311516370586683, 0.32211222486046975, 0.31567472895229876], [0.24518097756405755, 0.2423828172773036, 0.24631391467731628], 0.0), Branch{Float64, 1}([125], UnitRange{Int64}[487:611], 8, 42:49, 1, -1, [0.25885524918826863, 0.2546885507881843, 0.7713209298120647], [0.2615837372432516, 0.2520462106455035, 0.7609197959015138], 0.46286949492509166, 0.39311090065745397, [0.29913072038979494, 0.33129872576306274, 0.2922650476301434], [0.23174503216826497, 0.24688254433858625, 0.22490045471800146], 0.0), Branch{Float64, 1}([126], UnitRange{Int64}[612:737], 8, 50:57, 1, -1, [0.7589969915559551, 0.2534709844561074, 0.7345664679909352], [0.7497230281995486, 0.25215008014048756, 0.7503775840720435], 0.4674472426165294, 0.40850776824660795, [0.3053847680090085, 0.31204914873095757, 0.30844203700490636], [0.24469152054139087, 0.24627902672027047, 0.2481305941754237], 0.0), Branch{Float64, 1}([112], UnitRange{Int64}[738:849], 8, 58:65, 1, -1, [0.25560961888190625, 0.7499724770575975, 0.7568198221284095], [0.25843882604414375, 0.7491258547756303, 0.74959327365901], 0.48022098062988905, 0.4092304512412248, [0.31864602892896043, 0.31113017871149906, 0.3195328530203958], [0.24474430906253436, 0.24698490887005442, 0.24797545513292396], 0.0), Branch{Float64, 1}([151], UnitRange{Int64}[850:1000], 8, 66:73, 1, -1, [0.7516068858244844, 0.7617578402976709, 0.7482986334639216], [0.7535450835807624, 0.7537771863373883, 0.7476207650540311], 0.45554103840525756, 0.40645857505777144, [0.31746644815608027, 0.31567595473118837, 0.30587867488784803], [0.24631366855587777, 0.24559255943701053, 0.24651548757378527], 0.0), Branch{Float64, 1}([22], UnitRange{Int64}[1:22], 0, 74:73, 2, 1, [0.1119134768485247, 0.11809931909296659, 0.10558033452246798], [0.12353421619908211, 0.12072358540496836, 0.12137346595871273], 0.24918445523081567, 0.19094566599530993, [0.17545388005704426, 0.17956374438830772, 0.16818922234162922], [0.11457005673052434, 0.11847804351410035, 0.11291343837352624], 0.0)  …  Branch{Float64, 1}([25], UnitRange{Int64}[958:982], 0, 82:81, 9, 62, [0.6425472323075379, 0.8848544112806114, 0.8758695221819778], [0.6316515377692793, 0.8761883748433387, 0.8733175472338881], 0.24740381092946645, 0.174388731851731, [0.1946999273208918, 0.1925793837482479, 0.17830778616979182], [0.12146154324292668, 0.12318137093106019, 0.12081870539392825], 0.0), Branch{Float64, 1}([18], UnitRange{Int64}[983:1000], 0, 82:81, 9, 63, [0.8862634716697911, 0.8771727331128197, 0.8560010579551269], [0.8780944355088784, 0.8773098662755738, 0.860199490696723], 0.2247593838660758, 0.16292315926336165, [0.18280986231077356, 0.17356248396276086, 0.16060155793158537], [0.11686027717266723, 0.1164488039429803, 0.10013546591301625], 0.0), Branch{Float64, 1}([3], UnitRange{Int64}[398:400], 0, 82:81, 37, 64, [0.8450996038074694, 0.8489077524079158, 0.05428249018786257], [0.8524529950558957, 0.840886579668116, 0.04626131744806283], 0.11252726399661, 0.042500178733638094, [0.08643531281082428, 0.09579426227135746, 0.0846568357855722], [0.0210487762518754, 0.03107550720378216, 0.019938080717996853], 0.0), Branch{Float64, 1}([3], UnitRange{Int64}[401:403], 0, 82:81, 37, 65, [0.9633038325777155, 0.8155981165407806, 0.03174041213175651], [0.955767894370058, 0.8188303795583654, 0.043435032749719604], 0.10829354386181872, 0.04102197526716475, [0.09348729442878856, 0.0825215819970434, 0.10123035230710273], [0.02753623357448709, 0.0032322630175848355, 0.030403390928022467], 0.0), Branch{Float64, 1}([5], UnitRange{Int64}[404:408], 0, 82:81, 37, 66, [0.8226883104230103, 0.9786736220824446, 0.07583976483651353], [0.8244144189043601, 0.9545916834902264, 0.075865760664029], 0.12148617380072976, 0.05503962231452518, [0.09286712561369426, 0.09226602285813623, 0.11112542566374214], [0.028822825816081976, 0.039230379114738256, 0.04538101321229554], 0.0), Branch{Float64, 1}([1], UnitRange{Int64}[409:409], 0, 82:81, 37, 67, [0.9356501064976743, 0.9581376418865672, 0.09034199569036971], [0.9356501064976743, 0.9581376418865672, 0.09034199569036971], 0.061217700521775026, 0.0, [0.061217700521775, 0.06121770052177511, 0.061217700521775026], [0.0, 0.0, 0.0], 0.0), Branch{Float64, 1}([3], UnitRange{Int64}[410:412], 0, 82:81, 37, 68, [0.7848375481480214, 0.8209715009515516, 0.21184465174879222], [0.7990478030924413, 0.8062406286345208, 0.21460716236298888], 0.11360689179336408, 0.04734851500456406, [0.08355951352044877, 0.09931288291261675, 0.0957477855359404], [0.021656537439288526, 0.03688928945884562, 0.02135583037933525], 0.0), Branch{Float64, 1}([7], UnitRange{Int64}[413:419], 0, 82:81, 37, 69, [0.925205958743082, 0.8159589447424132, 0.19455764840971476], [0.9295577383338196, 0.8053599687960394, 0.19351433475860086], 0.15394302833674775, 0.0789042179017191, [0.11424380793992273, 0.11247198672948411, 0.13645762729274794], [0.03704187749961596, 0.04151725264481354, 0.05594723091281756], 0.0), Branch{Float64, 1}([2], UnitRange{Int64}[420:421], 0, 82:81, 37, 70, [0.8412505492126917, 0.9253143472321, 0.14727614008440396], [0.842386382991002, 0.9264501810104103, 0.14841197386271426], 0.10174436110256588, 0.03754906121570654, [0.09722798252707676, 0.08003285536384841, 0.06782387933278436], [0.03354684687675602, 0.016351719713527668, 0.0041427436824636454], 0.0), Branch{Float64, 1}([5], UnitRange{Int64}[422:426], 0, 82:81, 37, 71, [0.920199810358828, 0.9643263224048215, 0.1698596277116868], [0.928021176088388, 0.9548919005705834, 0.18377139177416857], 0.11963699222736449, 0.068685296601054, [0.07531679851956685, 0.09955411397068437, 0.10894227787920377], [0.029471057580933935, 0.04031565160757533, 0.05418115774433829], 0.0)], [0.0 0.0; 0.0 0.0;;; 9.085401100762653e-5 -0.00029344409304671006; 0.0 0.0;;; 3.823963978375807e-5 0.00015250271814770005; 6.795318534133415e-5 -0.0007561534385155661;;;; 0.0 0.0; 0.0 0.0;;; -1.953990413859174e-5 -0.0002011014179534245; 0.0 0.0;;; -3.5523695202942324e-5 6.422021012947684e-5; 7.5458923372361575e-6 -0.0002342978822541968;;;; 0.0 0.0; 0.0 0.0;;; 2.4773187066684562e-6 -0.0004010775965237804; 0.0 0.0;;; -1.0012368551575646e-5 0.00017998835014523996; 2.721805342473138e-5 -3.1605231185122485e-5;;;; … ;;;; 0.0 0.0; 0.0 0.0;;; -2.235477153151388e-7 -5.331111133367922e-5; 0.0 0.0;;; -3.4225643878728953e-8 -7.819760491985443e-5; -3.4629832613084874e-7 -3.1606954970832144e-5;;;; 0.0 0.0; 0.0 0.0;;; -2.2901343301061848e-8 9.790335119539258e-5; 0.0 0.0;;; 6.663996452398282e-7 2.9953921124350903e-5; -3.051874279810747e-7 3.924241267959189e-5;;;; 0.0 0.0; 0.0 0.0;;; -1.0535342169947125e-7 5.946426215525859e-5; 0.0 0.0;;; 6.690228775259219e-7 1.1393570826659245e-5; -6.926583503541312e-7 3.3442754621469786e-5], UnitRange{Int64}[1:1, 2:9, 10:73, 74:81], [10, 11, 12, 13, 14, 15, 16, 17, 18, 19  …  72, 73, 74, 75, 76, 77, 78, 79, 80, 81], ([109, 184, 208, 235, 254, 331, 382, 411, 453, 455  …  530, 547, 552, 626, 727, 732, 737, 799, 817, 927],), ([159, 44, 328, 722, 838, 612, 693, 801, 924, 58  …  192, 692, 500, 837, 175, 208, 106, 379, 295, 358],), ([0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; … ; 0.15364977568198596 0.004438653682646284 … 0.7412416553292829 0.7768139355631294; 0.01 0.01 … 0.01 0.01],), [[0.07873489703804126 0.12996166331541437 … 0.8665882405274722 0.9470337853199925; 0.16307530228687372 0.1340977337840451 … 0.9054393004512419 0.8497198362305189; 0.16199329825664965 0.02946021566549939 … 0.7808514891852235 0.7600640247837067]], 1, [10]), StaticArraysCore.SVector{2, Int32}[[42, 37], [43, 37], [46, 37], [47, 37], [48, 37], [49, 37], [54, 37], [62, 37], [64, 37]], StaticArraysCore.SVector{2, Int32}[[10, 10], [10, 11], [10, 12], [10, 13], [10, 14], [10, 15], [10, 16], [10, 17], [10, 18], [10, 19]  …  [73, 64], [73, 65], [73, 66], [73, 67], [73, 68], [73, 69], [73, 70], [73, 71], [73, 72], [73, 73]], (DerivativesSwitch{false, true, false}(),), true)</code></pre><p>Note that <code>optargs</code> contains <code>leaf_size_source</code>, <code>expansion_order</code>, and <code>multipole_acceptance</code> parameters. Only <code>leaf_size_source</code> is tuned if <code>isnothing(ε_tol) == true</code>. More complete auto-tuning will be discussed later.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../quickstart/">« Quick Start</a><a class="docs-footer-nextpage" href="../advanced_usage/">Advanced Usage »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.12.0 on <span class="colophon-date" title="Tuesday 17 June 2025 20:06">Tuesday 17 June 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
